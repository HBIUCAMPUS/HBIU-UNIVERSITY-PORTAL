Here's the complete fixed `add_quiz.html` with all the null checks and safety fixes:

```html
{# templates/add_quiz.html #}
{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-1">
          <li class="breadcrumb-item"><a href="#">Course Builder</a></li>
          <li class="breadcrumb-item"><a href="#">Curriculum</a></li>
          <li class="breadcrumb-item active" aria-current="page">Quiz</li>
        </ol>
      </nav>
      <h5 class="mb-0">Quiz <small class="text-muted">Topic: {{ chapter.title if chapter else 'â€”' }}</small></h5>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" type="button" onclick="history.back()">Cancel</button>
      <button class="btn btn-primary" form="quizForm" type="submit">Save</button>
    </div>
  </div>
  
  <!-- Chapter Selection -->
  <div class="col-12">
    <div class="card mb-3">
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Select Chapter <span class="text-danger">*</span></label>
          <select class="form-select" id="chapterSelect" name="chapter_id" required>
            <option value="">-- Select a Chapter --</option>
            {% for chapter in chapters %}
            <option value="{{ chapter.id }}">{{ chapter.title }}</option>
            {% endfor %}
            <option value="new">+ Create New Chapter</option>
          </select>
        </div>
        
        <!-- New Chapter Input (shown when "Create New Chapter" is selected) -->
        <div id="newChapterSection" class="d-none">
          <div class="mb-3">
            <label class="form-label">New Chapter Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="new_chapter_title" placeholder="Enter chapter title" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Chapter Description</label>
            <textarea class="form-control" name="new_chapter_description" rows="2" placeholder="Optional chapter description"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <form id="quizForm"
      method="POST"
      action="{{ url_for('api_create_item', unit_id=unit.id) }}"
      enctype="multipart/form-data"
      class="row g-3">

    <!-- Hidden fields for API -->
    <input type="hidden" name="type" value="quiz">
    <input type="hidden" name="chapter_id" id="finalChapterId" value="">
    <input type="hidden" name="duration" id="durationField" value="">

    <!-- Left: Quiz meta & builder -->
    <div class="col-12 col-lg-8">
      <div class="card mb-3">
        <div class="card-body">
          <!-- Title -->
          <div class="mb-3">
            <label class="form-label">Quiz Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="title" placeholder="Enter quiz title"
                   value="{{ item.title if item else '' }}" required>
          </div>

          <!-- Instructions -->
          <div class="mb-2 d-flex justify-content-between align-items-center">
            <label class="form-label mb-0">Instructions</label>
            <span class="text-muted small">Shown to students before starting</span>
          </div>
          <textarea class="form-control" name="instructions" rows="6"
            placeholder="Explain rules, materials allowed, grading criteria, etc.">{{ item.instructions if item else '' }}</textarea>

          <!-- Optional simple question builder (stored as JSON in hidden field) -->
          <hr>
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Questions (optional)</h6>
            <button class="btn btn-sm btn-outline-primary" type="button" onclick="addQ()">+ Add Question</button>
          </div>
          <div class="form-text mb-2">Add multiple choice questions. The first correct answer will be used for grading.</div>
          <div id="qList" class="mt-2"></div>
          <input type="hidden" name="content" id="qPayload"> {# stores JSON of questions #}
          <div class="form-text mt-1">
            If you prefer, skip the builder and upload a quiz file on the right.
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Settings & Upload -->
    <div class="col-12 col-lg-4">
      <div class="card mb-3">
        <div class="card-body">
          <h6 class="card-title mb-3">Quiz Settings</h6>

          <label class="form-label">Time Limit (minutes)</label>
          <div class="row g-2 mb-3">
            <div class="col-12">
              <input type="number" min="0" class="form-control" name="duration_minutes"
                     placeholder="0" value="{{ item.duration_minutes if item else '' }}">
              <div class="form-text">0 = No time limit</div>
            </div>
          </div>

          <label class="form-label">Maximum Attempts</label>
          <div class="row g-2 mb-3">
            <div class="col-12">
              <input type="number" min="1" max="10" class="form-control" name="max_attempts" placeholder="1" value="1">
              <div class="form-text">Number of times students can take this quiz</div>
            </div>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="shuffle" id="shuffle" value="true">
            <label class="form-check-label" for="shuffle">Shuffle questions</label>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="show_answers" id="show_answers" value="true">
            <label class="form-check-label" for="show_answers">Show correct answers after submit</label>
          </div>

          <hr>
          <h6 class="card-title mb-2">Upload Quiz File</h6>
          <input class="form-control" type="file" name="attachment" accept=".pdf,.doc,.docx,.csv,.xlsx,.zip,.txt">
          <div class="form-text">Optional. Upload a prepared quiz file or question bank.</div>
        </div>
      </div>

      <!-- Points and Grading -->
      <div class="card mb-3">
        <div class="card-body">
          <h6 class="card-title mb-3">Grading</h6>
          
          <div class="mb-3">
            <label class="form-label">Total Points</label>
            <input type="number" min="1" class="form-control" name="total_points" placeholder="100" value="100">
            <div class="form-text">Total points for this quiz</div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Passing Score (%)</label>
            <input type="number" min="0" max="100" class="form-control" name="passing_score" placeholder="70" value="70">
            <div class="form-text">Minimum score required to pass</div>
          </div>
        </div>
      </div>

      <!-- Preview toggle -->
      <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title mb-1">Quiz Preview</h6>
            <small class="text-muted">Allow preview before enrollment</small>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" name="is_preview" value="true"
                   {% if item and item.is_preview %}checked{% endif %}>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<style>
.card-title { font-weight: 600; } 
#qList .card { border-left: 4px solid #4e73df; }
.required-field::after { content: " *"; color: #dc3545; }
</style>

<script>
const qList = document.getElementById('qList');
const qPayload = document.getElementById('qPayload');
let qCounter = 0;

function addQ() {
  qCounter++;
  const id = `q${qCounter}`;
  const card = document.createElement('div');
  card.className = 'card mb-3';
  card.innerHTML = `
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Question ${qCounter}</strong>
        <button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('.card').remove(); syncJSON()">Remove</button>
      </div>
      <div class="mb-2">
        <label class="form-label small">Question Text</label>
        <input class="form-control" name="${id}_text" placeholder="Enter your question here..." required>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-9">
          <label class="form-label small">Option A</label>
          <input class="form-control" name="${id}_opt1" placeholder="Option A" required>
        </div>
        <div class="col-3">
          <label class="form-label small">Correct?</label>
          <select class="form-select" name="${id}_ans1">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-9">
          <label class="form-label small">Option B</label>
          <input class="form-control" name="${id}_opt2" placeholder="Option B" required>
        </div>
        <div class="col-3">
          <label class="form-label small">Correct?</label>
          <select class="form-select" name="${id}_ans2">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-9">
          <label class="form-label small">Option C</label>
          <input class="form-control" name="${id}_opt3" placeholder="Option C">
        </div>
        <div class="col-3">
          <label class="form-label small">Correct?</label>
          <select class="form-select" name="${id}_ans3">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
      </div>
      <div class="row g-2">
        <div class="col-9">
          <label class="form-label small">Option D</label>
          <input class="form-control" name="${id}_opt4" placeholder="Option D">
        </div>
        <div class="col-3">
          <label class="form-label small">Correct?</label>
          <select class="form-select" name="${id}_ans4">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
      </div>
    </div>`;
  if (qList) {
    qList.appendChild(card);
    Array.from(card.querySelectorAll('input,select')).forEach(el => el.addEventListener('input', syncJSON));
    syncJSON();
  }
}

function syncJSON() {
  if (!qPayload) return;
  
  const data = [];
  if (qList) {
    qList.querySelectorAll('.card').forEach((c, idx) => {
      const q = {
        text: c.querySelector(`[name^="q"][name$="_text"]`)?.value || '',
        options: [],
        points: 1,
        type: 'mcq'
      };
      
      for (let i=1;i<=4;i++){
        const optInput = c.querySelector(`[name^="q"][name$="_opt${i}"]`);
        const opt = optInput?.value || '';
        // Only add option if it has text
        if (opt.trim()) {
          const ans = c.querySelector(`[name^="q"][name$="_ans${i}"]`)?.value === 'true';
          q.options.push({ text: opt, correct: ans });
        }
      }
      
      // Only add question if it has text and at least 2 options
      if (q.text.trim() && q.options.length >= 2) {
        data.push(q);
      }
    });
  }
  qPayload.value = JSON.stringify(data);
  console.log('Questions JSON:', qPayload.value);
}

// Safe button state management
function setButtonState(loading) {
  const submitBtn = document.querySelector('button[form="quizForm"][type="submit"]');
  if (submitBtn) {
    if (loading) {
      submitBtn.dataset.originalText = submitBtn.textContent;
      submitBtn.textContent = 'Creating Quiz...';
      submitBtn.disabled = true;
    } else {
      submitBtn.textContent = submitBtn.dataset.originalText || 'Save';
      submitBtn.disabled = false;
    }
  }
}

// Function to submit the main form and handle response
async function submitMainForm() {
  const form = document.getElementById('quizForm');
  if (!form) {
    alert('Form not found');
    return;
  }
  
  const formData = new FormData(form);
  
  // Set duration from minutes field
  const durationMinutesInput = document.querySelector('input[name="duration_minutes"]');
  const durationField = document.getElementById('durationField');
  if (durationMinutesInput && durationField) {
    const durationMinutes = durationMinutesInput.value;
    if (durationMinutes && durationMinutes > 0) {
      durationField.value = durationMinutes + ' minutes';
      formData.set('duration', durationMinutes + ' minutes');
    }
  }
  
  // Log what we're sending
  console.log('=== SUBMITTING FORM DATA ===');
  const formDataObj = {};
  for (let [key, value] of formData.entries()) {
    formDataObj[key] = value;
    console.log(`${key}: ${value}`);
  }
  console.log('=== END FORM DATA ===');
  
  try {
    // Show loading state
    setButtonState(true);
    
    const response = await fetch(form.action, {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    console.log('API Response:', result);
    
    if (result.ok) {
      alert(result.message || 'Quiz created successfully!');
      // Redirect back to the learning interface
      setTimeout(() => {
        const redirectUrl = result.redirect_url || "{{ url_for('learning_interface', unit_id=unit.id) }}";
        window.location.href = redirectUrl;
      }, 1000);
    } else {
      alert('Error creating quiz: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error submitting form:', error);
    alert('Error creating quiz: ' + error.message);
  } finally {
    // Always restore button state
    setButtonState(false);
  }
}

// FORM SUBMISSION HANDLER - COMPLETE FIXED VERSION
document.addEventListener('DOMContentLoaded', () => {
  // Chapter selection handling
  const chapterSelect = document.getElementById('chapterSelect');
  const newChapterSection = document.getElementById('newChapterSection');
  const finalChapterId = document.getElementById('finalChapterId');
  
  if (chapterSelect && newChapterSection && finalChapterId) {
    chapterSelect.addEventListener('change', function() {
      if (this.value === 'new') {
        newChapterSection.classList.remove('d-none');
        // Make new chapter title required
        const newChapterTitleInput = document.querySelector('input[name="new_chapter_title"]');
        if (newChapterTitleInput) {
          newChapterTitleInput.required = true;
        }
        finalChapterId.value = ''; // Clear for new chapter
      } else {
        newChapterSection.classList.add('d-none');
        // Remove required from new chapter title
        const newChapterTitleInput = document.querySelector('input[name="new_chapter_title"]');
        if (newChapterTitleInput) {
          newChapterTitleInput.required = false;
        }
        finalChapterId.value = this.value; // Set selected chapter_id
      }
    });
    
    // Initialize the finalChapterId with the default selected value
    if (chapterSelect.value && chapterSelect.value !== 'new') {
      finalChapterId.value = chapterSelect.value;
    }
  }

  // Form submission handler
  const quizForm = document.getElementById('quizForm');
  if (quizForm) {
    quizForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const chapterSelect = document.getElementById('chapterSelect');
      const finalChapterId = document.getElementById('finalChapterId');
      const titleInput = document.querySelector('input[name="title"]');
      
      console.log('=== QUIZ FORM SUBMISSION ===');
      console.log('Selected chapter:', chapterSelect?.value);
      console.log('Final chapter ID:', finalChapterId?.value);
      console.log('Quiz title:', titleInput?.value);
      
      // Validate basic required fields
      if (!chapterSelect || !chapterSelect.value) {
        alert('Please select a chapter');
        if (chapterSelect) chapterSelect.focus();
        return;
      }
      
      if (!titleInput || !titleInput.value.trim()) {
        alert('Please enter a quiz title');
        if (titleInput) titleInput.focus();
        return;
      }
      
      // If creating a new chapter, validate and create it first
      if (chapterSelect.value === 'new') {
        const newChapterTitleInput = document.querySelector('input[name="new_chapter_title"]');
        const newChapterTitle = newChapterTitleInput?.value || '';
        
        if (!newChapterTitle.trim()) {
          alert('Please enter a chapter title');
          if (newChapterTitleInput) newChapterTitleInput.focus();
          return;
        }
        
        try {
          console.log('Creating new chapter...');
          const response = await fetch(`/api/unit/{{ unit.id }}/chapter`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `title=${encodeURIComponent(newChapterTitle)}&description=${encodeURIComponent(document.querySelector('textarea[name="new_chapter_description"]')?.value || '')}`
          });
          
          const result = await response.json();
          console.log('Chapter creation response:', result);
          
          if (result.ok) {
            // Set the new chapter ID and submit the form
            if (finalChapterId) {
              finalChapterId.value = result.chapter_id;
            }
            console.log('New chapter created with ID:', result.chapter_id);
            
            // Now submit the main form
            await submitMainForm();
          } else {
            alert('Error creating chapter: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error creating chapter:', error);
          alert('Error creating chapter: ' + error.message);
        }
      } else {
        // Submit normally for existing chapter
        console.log('Submitting with existing chapter ID:', chapterSelect.value);
        if (finalChapterId) {
          finalChapterId.value = chapterSelect.value; // Ensure it's set
        }
        await submitMainForm();
      }
    });
  }

  // Add a couple of sample questions on first load for demonstration
  setTimeout(() => {
    if (qList && qList.children.length === 0) {
      console.log('Adding sample questions...');
      // Add two sample questions
      addQ();
      addQ();
      
      // Set sample data for first question
      setTimeout(() => {
        const firstCard = qList.querySelector('.card');
        if (firstCard) {
          const textInput = firstCard.querySelector('[name="q1_text"]');
          const opt1Input = firstCard.querySelector('[name="q1_opt1"]');
          const opt2Input = firstCard.querySelector('[name="q1_opt2"]');
          const ans2Select = firstCard.querySelector('[name="q1_ans2"]');
          const opt3Input = firstCard.querySelector('[name="q1_opt3"]');
          const opt4Input = firstCard.querySelector('[name="q1_opt4"]');
          
          if (textInput) textInput.value = "What is the capital of France?";
          if (opt1Input) opt1Input.value = "London";
          if (opt2Input) opt2Input.value = "Paris";
          if (ans2Select) ans2Select.value = "true";
          if (opt3Input) opt3Input.value = "Berlin";
          if (opt4Input) opt4Input.value = "Madrid";
          
          syncJSON();
        }
      }, 100);
    }
  }, 500);
});
</script>
{% endblock %}
```

## Key fixes applied:

1. **Added null checks everywhere** - All DOM element accesses now have safety checks
2. **Fixed the button state management** - Uses `setButtonState()` function with proper null checks
3. **Safe form submission** - All form elements are checked before accessing
4. **Preserved all existing functionality** - The quiz builder, chapter creation, and file uploads all work exactly as before
5. **Better error handling** - More descriptive error messages and proper cleanup

The form will now handle the quiz creation without the "Cannot read properties of null" error while maintaining all the original features and functionality.
