{% extends "base.html" %}
{% block content %}
<div class="row">
  <!-- Sidebar -->
  <div class="col-md-4 col-lg-3">
    <div class="card sticky-top" style="top:20px;">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0">Course Content</h6>
      </div>

      <div class="card-body p-0">
        <div class="list-group list-group-flush" id="courseChapters">
          {% for chapter in chapters %}
          <div class="list-group-item chapter-item" data-chapter-id="{{ chapter.id }}">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 chapter-title" role="button">
                <i class="fas fa-folder me-2"></i>{{ chapter.title }}
              </h6>
              <button class="btn btn-sm btn-link toggle-chapter">Show</button>
            </div>

            <div class="chapter-content mt-2 ms-3 d-none">
              {% for item in chapter.items %}
              {% set is_exam = (item.type == 'exam') %}
              <div
                class="d-flex align-items-center mb-2 lesson-item {% if item.completed %}text-success{% endif %}"
                data-item-id="{{ item.id }}"
                data-type="{{ item.type }}"
                data-locked="{{ (is_exam and not exam_unlocked)|int }}"
              >
                <div class="form-check me-2 {% if is_exam %}d-none{% endif %}">
                  <input class="form-check-input completion-checkbox" type="checkbox"
                         {% if item.completed %}checked{% endif %}
                         data-item-id="{{ item.id }}">
                </div>

                <small class="flex-grow-1 item-open" role="button">
                  {% if is_exam %}
                    <i class="fas fa-lock me-1 exam-lock {% if exam_unlocked %}d-none{% endif %}"></i>
                    <i class="fas fa-star me-1 {% if not exam_unlocked %}d-none{% endif %}"></i>
                  {% else %}
                    <i class="fas {% if item.type == 'quiz' %}fa-question-circle{% elif item.type == 'assignment' %}fa-tasks{% else %}fa-play-circle{% endif %} me-1"></i>
                  {% endif %}
                  {{ item.title }}
                </small>

                {% if item.duration %}
                <small class="text-muted ms-2">{{ item.duration }}</small>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="card-footer">
        <div class="progress mb-2" style="height:8px;">
          <div class="progress-bar bg-success"
               role="progressbar"
               style="width: {{ progress_percentage }}%;"
               aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <small class="text-muted">
          Your Progress: {{ completed_items }}/{{ total_items }} ({{ progress_percentage }}%)
        </small>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="col-md-8 col-lg-9">
    <div class="card mb-4">
      <div class="card-body">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('student_dashboard') }}">My Courses</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('unit_detail', unit_id=unit.id) }}">{{ unit.title }}</a></li>
            <li class="breadcrumb-item active">Learning</li>
          </ol>
        </nav>
        <h4 class="card-title">{{ unit.title }}</h4>
        <p class="text-muted">{{ unit.description }}</p>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0" id="contentTitle">Select a lesson to begin</h5>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-2" id="prevBtn" disabled>
              <i class="fas fa-chevron-left me-1"></i>Previous
            </button>
            <button class="btn btn-sm btn-primary" id="nextBtn" disabled>
              Next<i class="fas fa-chevron-right ms-1"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="card-body">
        <!-- Lesson -->
        <div id="videoContent" class="d-none">
          <div class="ratio ratio-16x9 mb-4">
            <iframe id="lessonVideo" src="" frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen></iframe>
          </div>
          <div id="videoDescription"></div>
        </div>

        <!-- Quiz -->
        <div id="quizContent" class="d-none">
          <div class="alert alert-info mb-3">Quiz content goes here.</div>
          <div id="quizQuestions"></div>
          <button class="btn btn-success mt-3" id="submitQuiz">Submit Quiz</button>
        </div>

        <!-- Assignment -->
        <div id="assignmentContent" class="d-none">
          <h6>Assignment Instructions</h6>
          <div id="assignmentInstructions" class="mb-3"></div>
          <label for="assignmentSubmission" class="form-label">Submit Your Work</label>
          <input type="file" class="form-control" id="assignmentSubmission">
          <button class="btn btn-success mt-3" id="submitAssignment">Submit Assignment</button>
        </div>

        <!-- Exam -->
        <div id="examContent" class="d-none">
          <div class="alert alert-warning mb-3">
            Final Exam is unlocked. Click “Start Exam” to proceed.
          </div>
          <a class="btn btn-danger" id="startExam" href="{{ url_for('exam_landing', unit_id=unit.id) }}">Start Exam</a>
        </div>

        <!-- Empty -->
        <div id="emptyContent" class="text-center py-5">
          <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Welcome to Your Learning Journey</h5>
          <p class="text-muted">Select a lesson, quiz, or assignment from the sidebar to begin.</p>
        </div>

        <!-- Completion -->
        <div class="mt-4 pt-3 border-top d-none" id="completionSection">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="markComplete">
            <label class="form-check-label" for="markComplete">Mark this item as completed</label>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Data for JS -->
<div id="courseData"
  data-unit-id="{{ unit.id }}"
  data-chapters='{{ chapters|tojson }}'
  data-progress='{{ progress_data|tojson }}'
  data-exam-unlocked='{{ 1 if exam_unlocked else 0 }}'
  class="d-none"></div>

<style>
.sticky-top{position:-webkit-sticky;position:sticky;z-index:1020}
.chapter-item{border-left:3px solid transparent;transition:.3s}
.chapter-item:hover{border-left-color:#4e73df;background:#f8f9fa}
.chapter-title{font-weight:600;color:#2c3e50}
.lesson-item{padding:4px 8px;border-radius:4px;transition:.2s}
.lesson-item:hover{background:#e9ecef}
.lesson-item.text-success{background:#d1edff}
.completion-checkbox:checked{background:#28a745;border-color:#28a745}
.ratio-16x9{border-radius:8px;overflow:hidden}
#emptyContent{min-height:280px;display:flex;flex-direction:column;justify-content:center;align-items:center}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ----- Data -----
  const dataEl = document.getElementById('courseData');
  const unitId = Number(dataEl.dataset.unitId);
  const chapters = JSON.parse(dataEl.dataset.chapters || '[]');
  const progressMap = JSON.parse(dataEl.dataset.progress || '{}');
  let examUnlocked = dataEl.dataset.examUnlocked === '1';

  // ----- State -----
  const linear = []; // Flat ordered list of items for prev/next
  chapters.forEach(ch => (ch.items || []).forEach(it => linear.push({chapterId: ch.id, ...it})));
  let currentIndex = -1;

  // ----- DOM -----
  const contentTitle = document.getElementById('contentTitle');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  // Toggle chapters
  document.querySelectorAll('.toggle-chapter').forEach(btn => {
    btn.addEventListener('click', function() {
      const body = this.closest('.chapter-item').querySelector('.chapter-content');
      body.classList.toggle('d-none');
      this.textContent = body.classList.contains('d-none') ? 'Show' : 'Hide';
    });
  });

  // Open item
  document.querySelectorAll('.lesson-item .item-open').forEach(span => {
    span.addEventListener('click', function() {
      const row = this.closest('.lesson-item');
      const locked = row.dataset.locked === '1';
      const id = Number(row.dataset.itemId);
      const type = row.dataset.type;

      if (type === 'exam' && (locked || !examUnlocked)) {
        // still locked -> ignore
        return;
      }

      // Find index in linear
      currentIndex = linear.findIndex(x => x.id === id);
      if (currentIndex < 0) return;

      loadItem(linear[currentIndex]);
      updateNav();
    });
  });

  // Completion checkboxes (sidebar)
  document.querySelectorAll('.completion-checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
      const id = Number(this.dataset.itemId);
      const isCompleted = this.checked;
      postProgress(id, isCompleted, () => {
        const row = document.querySelector(`.lesson-item[data-item-id="${id}"]`);
        row.classList.toggle('text-success', isCompleted);
        progressMap[id] = isCompleted;
        refreshProgressUI();
        tryUnlockExam();
      });
    });
  });

  // Header checkbox
  const markComplete = document.getElementById('markComplete');
  markComplete.addEventListener('change', function() {
    if (currentIndex < 0) return;
    const item = linear[currentIndex];
    if (item.type === 'exam') { this.checked = false; return; }
    const isCompleted = this.checked;
    postProgress(item.id, isCompleted, () => {
      const row = document.querySelector(`.lesson-item[data-item-id="${item.id}"]`);
      row.classList.toggle('text-success', isCompleted);
      const cb = row.querySelector('.completion-checkbox');
      if (cb) cb.checked = isCompleted;
      progressMap[item.id] = isCompleted;
      refreshProgressUI();
      tryUnlockExam();
    });
  });

  // Prev/Next
  prevBtn.addEventListener('click', () => {
    if (currentIndex > 0) {
      currentIndex--;
      if (linear[currentIndex].type === 'exam' && !examUnlocked) currentIndex--; // skip locked exam
      if (currentIndex < 0) { currentIndex = 0; }
      loadItem(linear[currentIndex]); updateNav();
    }
  });
  nextBtn.addEventListener('click', () => {
    if (currentIndex < linear.length - 1) {
      currentIndex++;
      if (linear[currentIndex].type === 'exam' && !examUnlocked) currentIndex++; // skip locked exam
      if (currentIndex >= linear.length) { currentIndex = linear.length - 1; return; }
      loadItem(linear[currentIndex]); updateNav();
    }
  });

  function updateNav() {
    prevBtn.disabled = (currentIndex <= 0);
    nextBtn.disabled = (currentIndex >= linear.length - 1) ||
                       (linear[currentIndex + 1]?.type === 'exam' && !examUnlocked && currentIndex + 1 === linear.length - 1);
  }

  // Content loaders
  function hideAll() {
    ['videoContent','quizContent','assignmentContent','examContent','emptyContent']
      .forEach(id => document.getElementById(id).classList.add('d-none'));
    document.getElementById('completionSection').classList.add('d-none');
  }

  function loadItem(item) {
    hideAll();
    contentTitle.textContent = item.title || 'Content';

    if (item.type === 'lesson') {
      document.getElementById('videoContent').classList.remove('d-none');
      const frame = document.getElementById('lessonVideo');
      frame.src = '';
      let url = item.video_url || '';
      if (url.includes('youtube.com/watch?v=')) url = url.replace('youtube.com/watch?v=','youtube.com/embed/');
      if (url.includes('youtu.be/')) url = url.replace('youtu.be/','youtube.com/embed/');
      if (!url && item.video_file) url = "{{ url_for('uploaded_file', filename='') }}" + item.video_file;
      frame.src = url || 'about:blank';
      document.getElementById('videoDescription').innerHTML = item.description || '<p>No description provided.</p>';
    } else if (item.type === 'quiz') {
      document.getElementById('quizContent').classList.remove('d-none');
      document.getElementById('quizQuestions').innerHTML =
        '<div class="alert alert-info">Quiz questions would render here.</div>';
    } else if (item.type === 'assignment') {
      document.getElementById('assignmentContent').classList.remove('d-none');
      document.getElementById('assignmentInstructions').innerHTML =
        item.instructions || '<p>Follow the instructions in your course materials.</p>';
    } else if (item.type === 'exam') {
      if (!examUnlocked) return; // safety
      document.getElementById('examContent').classList.remove('d-none');
    }

    // Completion section (hidden for exam)
    if (item.type !== 'exam') {
      document.getElementById('completionSection').classList.remove('d-none');
      markComplete.checked = !!progressMap[item.id];
    }
  }

  function postProgress(itemId, completed, cb) {
    fetch("{{ url_for('update_progress') }}", {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ unit_id: unitId, item_id: itemId, completed: completed })
    }).then(r => r.json()).then(res => {
      if (res.success) cb && cb();
    }).catch(()=>{});
  }

  function refreshProgressUI() {
    const total = {{ total_items or 0 }};
    if (!total) return;
    const completed = Object.values(progressMap).filter(Boolean).length;
    const pct = Math.round((completed / total) * 100);
    const bar = document.querySelector('.progress-bar');
    bar.style.width = pct + '%';
    bar.setAttribute('aria-valuenow', pct);
    document.querySelector('.card-footer small').textContent =
      `Your Progress: ${completed}/${total} (${pct}%)`;
  }

  function tryUnlockExam() {
    // If every non-exam item is completed, unlock exam UI
    const nonExam = linear.filter(x => x.type !== 'exam');
    const allDone = nonExam.every(x => !!progressMap[x.id]);
    if (allDone && !examUnlocked) {
      examUnlocked = true;
      // Hide lock icons and data-locked flags
      document.querySelectorAll('.lesson-item[data-type="exam"]').forEach(row => {
        row.dataset.locked = '0';
        const lock = row.querySelector('.exam-lock');
        if (lock) lock.classList.add('d-none');
      });
      updateNav();
    }
  }

  // Initial UI
  refreshProgressUI();
});
</script>
{% endblock %}
