{% extends "base.html" %}
{% block content %}
<div class="row">
  <!-- Sidebar -->
  <div class="col-md-4 col-lg-3">
    <div class="card sticky-top" style="top:20px;">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0">Course Content</h6>
      </div>

      <div class="card-body p-0">
        <div class="list-group list-group-flush" id="courseChapters">
          {% for chapter in chapters %}
          <div class="list-group-item chapter-item" data-chapter-id="{{ chapter.id }}">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 chapter-title" role="button" onclick="toggleChapter(this)">
                <i class="fas fa-folder me-2"></i>{{ chapter.title }}
                {% if chapter.description %}
                <small class="text-muted d-block mt-1">{{ chapter.description }}</small>
                {% endif %}
              </h6>
              <button class="btn btn-sm btn-link toggle-chapter" onclick="toggleChapter(this)">
                <i class="fas fa-chevron-down"></i>
              </button>
            </div>

            <div class="chapter-content mt-2 ms-3" style="display: none;">
              {% if chapter.items %}
                {% if chapter.items is iterable and chapter.items is not string %}
                  {% for item in chapter.items %}
                  {% set is_exam = (item.type == 'exam') %}
                  <div
                    class="d-flex align-items-center mb-2 lesson-item {% if item.completed %}text-success{% endif %} {% if is_exam and not exam_unlocked %}text-muted{% endif %}"
                    data-item-id="{{ item.id }}"
                    data-type="{{ item.type }}"
                    data-locked="{{ (is_exam and not exam_unlocked)|int }}"
                    onclick="loadItemContent({{ item|tojson }})"
                    style="cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: all 0.2s ease;"
                    onmouseover="this.style.backgroundColor='#f8f9fa'" 
                    onmouseout="this.style.backgroundColor='transparent'"
                  >
                    <div class="form-check me-2 {% if is_exam %}d-none{% endif %}">
                      <input class="form-check-input completion-checkbox" type="checkbox"
                             {% if item.completed %}checked{% endif %}
                             {% if is_exam and not exam_unlocked %}disabled{% endif %}
                             data-item-id="{{ item.id }}"
                             onclick="event.stopPropagation(); updateItemProgress({{ item.id }}, this.checked, {{ unit.id }})">
                    </div>

                    <small class="flex-grow-1">
                      {% if is_exam %}
                        {% if exam_unlocked %}
                        <i class="fas fa-star text-warning me-1"></i>
                        <strong>Final Exam</strong>
                        {% else %}
                        <i class="fas fa-lock me-1"></i>
                        <span class="text-muted">Final Exam (Complete all content first)</span>
                        {% endif %}
                      {% else %}
                        <i class="fas {% if item.type == 'quiz' %}fa-question-circle text-info{% elif item.type == 'assignment' %}fa-tasks text-warning{% else %}fa-play-circle text-primary{% endif %} me-1"></i>
                        {{ item.title }}
                      {% endif %}
                    </small>

                    {% if item.duration and not is_exam %}
                    <small class="text-muted ms-2">{{ item.duration }}</small>
                    {% endif %}
                  </div>
                  {% endfor %}
                {% else %}
                  <div class="text-muted small">No items available</div>
                {% endif %}
              {% else %}
                <div class="text-muted small">No items available</div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="card-footer">
        <div class="progress mb-2" style="height:8px;">
          <div class="progress-bar bg-success"
               role="progressbar"
               style="width: {{ progress_percentage }}%;"
               aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <small class="text-muted">
          Your Progress: {{ completed_items }}/{{ total_items }} ({{ progress_percentage }}%)
        </small>
        {% if not exam_unlocked and chapters|length >= 10 %}
        <div class="mt-2">
          <small class="text-warning">
            <i class="fas fa-info-circle"></i>
            Complete all items to unlock final exam
          </small>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="col-md-8 col-lg-9">
    <div class="card mb-4">
      <div class="card-body">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('student_dashboard') }}">My Courses</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('unit_detail', unit_id=unit.id) }}">{{ unit.title }}</a></li>
            <li class="breadcrumb-item active">Learning</li>
          </ol>
        </nav>
        <h4 class="card-title">{{ unit.title }}</h4>
        <p class="text-muted">{{ unit.description or "Course content and materials" }}</p>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0" id="contentTitle">Welcome to Your Learning Journey</h5>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-2" id="prevBtn" onclick="navigateItem(-1)" disabled>
              <i class="fas fa-chevron-left me-1"></i>Previous
            </button>
            <button class="btn btn-sm btn-primary" id="nextBtn" onclick="navigateItem(1)" disabled>
              Next<i class="fas fa-chevron-right ms-1"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="card-body">
        <!-- Lesson Content -->
        <div id="lessonContent" class="d-none">
          <div class="row">
            <div class="col-lg-8">
              <div id="videoContent" class="mb-4">
                <div class="ratio ratio-16x9 mb-3">
                  <iframe id="lessonVideo" src="" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">Lesson Materials</h6>
                </div>
                <div class="card-body">
                  <div id="lessonMaterials"></div>
                  {% if session.user_type == 'lecturer' or session.user_type == 'admin' %}
                  <div class="mt-3">
                    <a href="{{ url_for('add_lesson_page', unit_id=unit.id) }}" class="btn btn-sm btn-outline-primary w-100" target="_blank">
                      Edit Lesson
                    </a>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          <div id="lessonDescription" class="mt-3"></div>
        </div>

        <!-- Quiz Content -->
        <div id="quizContent" class="d-none">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <span id="quizInstructions">Complete the quiz to test your understanding.</span>
          </div>
          <div id="quizQuestions" class="mb-4"></div>
          <div class="d-flex justify-content-between align-items-center">
            <div id="quizProgress" class="text-muted small"></div>
            <button class="btn btn-success" id="submitQuiz" onclick="submitQuiz()">
              <i class="fas fa-paper-plane me-1"></i>Submit Quiz
            </button>
          </div>
        </div>

        <!-- Assignment Content -->
        <div id="assignmentContent" class="d-none">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-circle me-2"></i>
            Make sure to submit before the due date.
          </div>
          <h6>Assignment Instructions</h6>
          <div id="assignmentInstructions" class="mb-4 p-3 bg-light rounded"></div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header">
                  <h6 class="mb-0">Submission</h6>
                </div>
                <div class="card-body">
                  <label for="assignmentSubmission" class="form-label">Upload Your Work</label>
                  <input type="file" class="form-control mb-2" id="assignmentSubmission" multiple>
                  <textarea class="form-control mb-2" id="assignmentComments" placeholder="Add any comments (optional)" rows="3"></textarea>
                  <button class="btn btn-success w-100" id="submitAssignment" onclick="submitAssignment()">
                    <i class="fas fa-upload me-1"></i>Submit Assignment
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">Assignment Details</h6>
                </div>
                <div class="card-body">
                  <div id="assignmentDetails"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Exam Content -->
        <div id="examContent" class="d-none">
          <div class="alert alert-warning">
            <i class="fas fa-star me-2"></i>
            <strong>Final Examination</strong> - This exam covers all course materials.
          </div>
          <div class="text-center py-4">
            <i class="fas fa-graduation-cap fa-4x text-warning mb-3"></i>
            <h4>Ready for Your Final Exam?</h4>
            <p class="text-muted mb-4">This exam tests your understanding of all course concepts covered in the chapters.</p>
            <a class="btn btn-danger btn-lg" id="startExam" href="{{ url_for('exam_landing', unit_id=unit.id) }}">
              <i class="fas fa-play-circle me-2"></i>Start Exam
            </a>
          </div>
        </div>

        <!-- Welcome Content -->
        <div id="welcomeContent" class="text-center py-5">
          <i class="fas fa-book-open fa-4x text-muted mb-3"></i>
          <h4 class="text-muted">Welcome to Your Learning Journey</h4>
          <p class="text-muted mb-4">Select a lesson, quiz, or assignment from the sidebar to begin learning.</p>
          <div class="row justify-content-center">
            <div class="col-md-8">
              <div class="card">
                <div class="card-body">
                  <h6>Getting Started</h6>
                  <ul class="list-unstyled text-start">
                    <li><i class="fas fa-play-circle text-primary me-2"></i>Start with lessons to learn new concepts</li>
                    <li><i class="fas fa-question-circle text-info me-2"></i>Take quizzes to test your knowledge</li>
                    <li><i class="fas fa-tasks text-warning me-2"></i>Complete assignments to apply what you've learned</li>
                    <li><i class="fas fa-star text-warning me-2"></i>Final exam unlocks after completing all content</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Completion Section -->
        <div class="mt-4 pt-3 border-top d-none" id="completionSection">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="markComplete" role="switch" onchange="markCurrentItemComplete(this.checked)">
            <label class="form-check-label" for="markComplete">
              <strong>Mark this item as completed</strong>
            </label>
          </div>
          <small class="text-muted">Check this when you've finished reviewing this content.</small>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.sticky-top {
  position: -webkit-sticky;
  position: sticky;
  z-index: 1020;
  max-height: 80vh;
  overflow-y: auto;
}
.chapter-item {
  border-left: 3px solid transparent;
  transition: all 0.3s ease;
}
.chapter-item:hover {
  border-left-color: #4e73df;
  background: #f8f9fa;
}
.chapter-title {
  font-weight: 600;
  color: #2c3e50;
  cursor: pointer;
}
.lesson-item {
  padding: 8px 12px;
  border-radius: 6px;
  transition: all 0.2s ease;
  border: 1px solid transparent;
}
.lesson-item:hover {
  background: #e9ecef;
  border-color: #dee2e6;
}
.lesson-item.text-success {
  background: #d1edff;
  border-color: #b8daff;
}
.completion-checkbox:checked {
  background-color: #28a745;
  border-color: #28a745;
}
.ratio-16x9 {
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
#welcomeContent {
  min-height: 400px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.quiz-question {
  border-left: 4px solid #4e73df;
  padding-left: 1rem;
  margin-bottom: 1.5rem;
}
.assignment-detail {
  padding: 0.5rem 0;
  border-bottom: 1px solid #eee;
}
.prose {
  line-height: 1.6;
}
.prose p {
  margin-bottom: 1rem;
}
</style>

<script>
// Global variables
let currentItem = null;
let allItems = [];

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Collect all items from the DOM
  allItems = [];
  
  document.querySelectorAll('.lesson-item').forEach(itemEl => {
    const item = {
      id: parseInt(itemEl.dataset.itemId),
      type: itemEl.dataset.type,
      title: itemEl.querySelector('.flex-grow-1').textContent.trim(),
      completed: itemEl.classList.contains('text-success'),
      locked: itemEl.dataset.locked === '1'
    };
    allItems.push(item);
  });

  // Expand first chapter by default if it has items
  const firstChapter = document.querySelector('.chapter-item');
  if (firstChapter) {
    const chapterContent = firstChapter.querySelector('.chapter-content');
    if (chapterContent && chapterContent.children.length > 0) {
      toggleChapter(firstChapter.querySelector('.chapter-title'));
    }
  }
});

// Toggle chapter expansion
function toggleChapter(element) {
  const chapterItem = element.closest('.chapter-item');
  const chapterContent = chapterItem.querySelector('.chapter-content');
  const toggleIcon = chapterItem.querySelector('.toggle-chapter i');
  
  if (chapterContent.style.display === 'none') {
    chapterContent.style.display = 'block';
    toggleIcon.className = 'fas fa-chevron-down';
  } else {
    chapterContent.style.display = 'none';
    toggleIcon.className = 'fas fa-chevron-right';
  }
}

// Load item content into main window
function loadItemContent(item) {
  if (item.type === 'exam' && !{{ 'true' if exam_unlocked else 'false' }}) {
    showNotification('Complete all content to unlock the final exam!', 'warning');
    return;
  }

  currentItem = item;
  
  // Hide all content sections
  document.getElementById('welcomeContent').classList.add('d-none');
  document.getElementById('lessonContent').classList.add('d-none');
  document.getElementById('quizContent').classList.add('d-none');
  document.getElementById('assignmentContent').classList.add('d-none');
  document.getElementById('examContent').classList.add('d-none');
  
  // Update title
  document.getElementById('contentTitle').textContent = item.title;
  
  // Show completion section for non-exam items
  if (item.type !== 'exam') {
    document.getElementById('completionSection').classList.remove('d-none');
    document.getElementById('markComplete').checked = item.completed;
  } else {
    document.getElementById('completionSection').classList.add('d-none');
  }
  
  // Load specific content based on type
  switch(item.type) {
    case 'lesson':
      loadLesson(item);
      break;
    case 'quiz':
      loadQuiz(item);
      break;
    case 'assignment':
      loadAssignment(item);
      break;
    case 'exam':
      loadExam(item);
      break;
  }
  
  // Update navigation buttons
  updateNavigation();
  
  // Highlight active item in sidebar
  highlightActiveItem(item.id);
}

// Load lesson content
function loadLesson(item) {
  const content = document.getElementById('lessonContent');
  content.classList.remove('d-none');
  
  // Video content
  const videoContent = document.getElementById('videoContent');
  videoContent.classList.add('d-none'); // Hide video for now
  
  // Lesson description
  const descriptionEl = document.getElementById('lessonDescription');
  descriptionEl.innerHTML = `
    <div class="prose">
      <h6>About this lesson</h6>
      <p>This lesson covers important concepts related to "${item.title}".</p>
      <p>In a real implementation, this content would come from your database.</p>
    </div>
  `;
  
  // Lesson materials
  const materialsEl = document.getElementById('lessonMaterials');
  materialsEl.innerHTML = `
    <p class="text-muted small">Lesson materials and resources would be displayed here.</p>
    <div class="d-grid gap-2">
      <button class="btn btn-outline-primary btn-sm" onclick="showNotification('Downloading lesson materials...', 'info')">
        <i class="fas fa-download me-1"></i>Download Notes
      </button>
    </div>
  `;
}

// Load quiz content
function loadQuiz(item) {
  const content = document.getElementById('quizContent');
  content.classList.remove('d-none');
  
  // Quiz instructions
  document.getElementById('quizInstructions').textContent = 
    'Complete the quiz to test your understanding of the material.';
  
  // Quiz questions
  const questionsEl = document.getElementById('quizQuestions');
  questionsEl.innerHTML = `
    <div class="quiz-question">
      <h6>1. Sample Question 1</h6>
      <div class="options">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="question_1" id="q_1_0">
          <label class="form-check-label" for="q_1_0">Option A</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="question_1" id="q_1_1">
          <label class="form-check-label" for="q_1_1">Option B</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="question_1" id="q_1_2">
          <label class="form-check-label" for="q_1_2">Option C</label>
        </div>
      </div>
    </div>
    <div class="quiz-question">
      <h6>2. Sample Question 2</h6>
      <div class="options">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="question_2" id="q_2_0">
          <label class="form-check-label" for="q_2_0">Option A</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="question_2" id="q_2_1">
          <label class="form-check-label" for="q_2_1">Option B</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="question_2" id="q_2_2">
          <label class="form-check-label" for="q_2_2">Option C</label>
        </div>
      </div>
    </div>
  `;
}

// Load assignment content
function loadAssignment(item) {
  const content = document.getElementById('assignmentContent');
  content.classList.remove('d-none');
  
  // Assignment instructions
  const instructionsEl = document.getElementById('assignmentInstructions');
  instructionsEl.innerHTML = `
    <div class="prose">
      <h6>Assignment: ${item.title}</h6>
      <p>Complete this assignment to demonstrate your understanding of the course material.</p>
      <p><strong>Requirements:</strong></p>
      <ul>
        <li>Submit your work in PDF format</li>
        <li>Include all relevant calculations and explanations</li>
        <li>Cite any references used</li>
      </ul>
    </div>
  `;
  
  // Assignment details
  const detailsEl = document.getElementById('assignmentDetails');
  detailsEl.innerHTML = `
    <div class="assignment-details">
      <p><strong>Due Date:</strong> One week from now</p>
      <p><strong>Points:</strong> 100</p>
      <p><strong>Submission Format:</strong> PDF</p>
    </div>
  `;
}

// Load exam content
function loadExam(item) {
  const content = document.getElementById('examContent');
  content.classList.remove('d-none');
}

// Update navigation buttons
function updateNavigation() {
  if (!currentItem) return;
  
  const currentIndex = allItems.findIndex(item => item.id === currentItem.id);
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  prevBtn.disabled = currentIndex <= 0;
  nextBtn.disabled = currentIndex >= allItems.length - 1;
}

// Navigate between items
function navigateItem(direction) {
  if (!currentItem) return;
  
  const currentIndex = allItems.findIndex(item => item.id === currentItem.id);
  const newIndex = currentIndex + direction;
  
  if (newIndex >= 0 && newIndex < allItems.length) {
    const nextItem = allItems[newIndex];
    
    // Skip locked exams
    if (nextItem.type === 'exam' && !{{ 'true' if exam_unlocked else 'false' }}) {
      if (direction > 0) {
        navigateItem(1); // Skip to next
      } else {
        navigateItem(-1); // Skip to previous
      }
      return;
    }
    
    loadItemContent(nextItem);
  }
}

// Mark current item as complete
function markCurrentItemComplete(completed) {
  if (!currentItem || currentItem.type === 'exam') return;
  
  updateItemProgress(currentItem.id, completed, {{ unit.id }});
}

// Update item progress
function updateItemProgress(itemId, completed, unitId) {
  fetch("{{ url_for('update_progress') }}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      unit_id: unitId,
      item_id: itemId,
      completed: completed
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update UI
      const itemElement = document.querySelector(`.lesson-item[data-item-id="${itemId}"]`);
      if (itemElement) {
        if (completed) {
          itemElement.classList.add('text-success');
        } else {
          itemElement.classList.remove('text-success');
        }
        
        // Update checkbox
        const checkbox = itemElement.querySelector('.completion-checkbox');
        if (checkbox) {
          checkbox.checked = completed;
        }
      }
      
      // Update current item status
      if (currentItem && currentItem.id === itemId) {
        currentItem.completed = completed;
      }
      
      showNotification(completed ? 'Item marked as completed!' : 'Item marked as incomplete.', 'success');
      
      // Update progress display
      updateProgressDisplay();
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Error updating progress.', 'error');
  });
}

// Update progress display
function updateProgressDisplay() {
  const completedItems = document.querySelectorAll('.lesson-item.text-success').length;
  const totalItems = document.querySelectorAll('.lesson-item').length;
  const progressPercentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
  
  // Update progress bar
  const progressBar = document.querySelector('.progress-bar');
  if (progressBar) {
    progressBar.style.width = `${progressPercentage}%`;
    progressBar.setAttribute('aria-valuenow', progressPercentage);
  }
  
  // Update progress text
  const progressText = document.querySelector('.card-footer small');
  if (progressText) {
    progressText.textContent = `Your Progress: ${completedItems}/${totalItems} (${progressPercentage}%)`;
  }
}

// Highlight active item in sidebar
function highlightActiveItem(itemId) {
  // Remove active class from all items
  document.querySelectorAll('.lesson-item').forEach(item => {
    item.classList.remove('active');
    item.style.backgroundColor = '';
  });
  
  // Add active class to current item
  const activeItem = document.querySelector(`.lesson-item[data-item-id="${itemId}"]`);
  if (activeItem) {
    activeItem.classList.add('active');
    activeItem.style.backgroundColor = '#e3f2fd';
  }
}

// Show notification
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  // Add to page
  document.body.appendChild(notification);
  
  // Auto remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
}

// Placeholder functions for form submissions
function submitQuiz() {
  showNotification('Quiz submitted successfully!', 'success');
}

function submitAssignment() {
  showNotification('Assignment submitted successfully!', 'success');
}
</script>
{% endblock %}
