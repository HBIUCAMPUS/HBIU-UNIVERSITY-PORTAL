{% extends "base.html" %}
{% block content %}
<div class="row">
  <!-- Sidebar -->
  <div class="col-md-4 col-lg-3">
    <div class="card sticky-top" style="top:20px;">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0">Course Content</h6>
      </div>

      <div class="card-body p-0">
        <div class="list-group list-group-flush" id="courseChapters">
          {% for chapter in chapters %}
          <div class="list-group-item chapter-item" data-chapter-id="{{ chapter.id }}">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 chapter-title" role="button" onclick="toggleChapter(this)">
                <i class="fas fa-folder me-2"></i>{{ chapter.title }}
                {% if chapter.description %}
                <small class="text-muted d-block mt-1">{{ chapter.description }}</small>
                {% endif %}
              </h6>
              <button class="btn btn-sm btn-link toggle-chapter" onclick="toggleChapter(this)">
                <i class="fas fa-chevron-down"></i>
              </button>
            </div>

            <div class="chapter-content mt-2 ms-3" style="display: none;">
              {% for item in chapter.items %}
              {% set is_exam = (item.type == 'exam') %}
              <div
                class="d-flex align-items-center mb-2 lesson-item {% if item.completed %}text-success{% endif %} {% if is_exam and not exam_unlocked %}text-muted{% endif %}"
                data-item-id="{{ item.id }}"
                data-type="{{ item.type }}"
                data-locked="{{ (is_exam and not exam_unlocked)|int }}"
                onclick="loadItemContent({{ item|tojson }})"
                style="cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: all 0.2s ease;"
                onmouseover="this.style.backgroundColor='#f8f9fa'" 
                onmouseout="this.style.backgroundColor='transparent'"
              >
                <div class="form-check me-2 {% if is_exam %}d-none{% endif %}">
                  <input class="form-check-input completion-checkbox" type="checkbox"
                         {% if item.completed %}checked{% endif %}
                         {% if is_exam and not exam_unlocked %}disabled{% endif %}
                         data-item-id="{{ item.id }}"
                         onclick="event.stopPropagation(); updateItemProgress({{ item.id }}, this.checked, {{ unit.id }})">
                </div>

                <small class="flex-grow-1">
                  {% if is_exam %}
                    {% if exam_unlocked %}
                    <i class="fas fa-star text-warning me-1"></i>
                    <strong>Final Exam</strong>
                    {% else %}
                    <i class="fas fa-lock me-1"></i>
                    <span class="text-muted">Final Exam (Complete all content first)</span>
                    {% endif %}
                  {% else %}
                    <i class="fas {% if item.type == 'quiz' %}fa-question-circle text-info{% elif item.type == 'assignment' %}fa-tasks text-warning{% else %}fa-play-circle text-primary{% endif %} me-1"></i>
                    {{ item.title }}
                  {% endif %}
                </small>

                {% if item.duration and not is_exam %}
                <small class="text-muted ms-2">{{ item.duration }}</small>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="card-footer">
        <div class="progress mb-2" style="height:8px;">
          <div class="progress-bar bg-success"
               role="progressbar"
               style="width: {{ progress_percentage }}%;"
               aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <small class="text-muted">
          Your Progress: {{ completed_items }}/{{ total_items }} ({{ progress_percentage }}%)
        </small>
        {% if not exam_unlocked and chapters|length >= 10 %}
        <div class="mt-2">
          <small class="text-warning">
            <i class="fas fa-info-circle"></i>
            Complete all items to unlock final exam
          </small>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="col-md-8 col-lg-9">
    <div class="card mb-4">
      <div class="card-body">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('student_dashboard') }}">My Courses</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('unit_detail', unit_id=unit.id) }}">{{ unit.title }}</a></li>
            <li class="breadcrumb-item active">Learning</li>
          </ol>
        </nav>
        <h4 class="card-title">{{ unit.title }}</h4>
        <p class="text-muted">{{ unit.description or "Course content and materials" }}</p>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0" id="contentTitle">Welcome to Your Learning Journey</h5>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-2" id="prevBtn" onclick="navigateItem(-1)" disabled>
              <i class="fas fa-chevron-left me-1"></i>Previous
            </button>
            <button class="btn btn-sm btn-primary" id="nextBtn" onclick="navigateItem(1)" disabled>
              Next<i class="fas fa-chevron-right ms-1"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="card-body">
        <!-- Lesson Content -->
        <div id="lessonContent" class="d-none">
          <div class="row">
            <div class="col-lg-8">
              <div id="videoContent" class="mb-4">
                <div class="ratio ratio-16x9 mb-3">
                  <iframe id="lessonVideo" src="" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">Lesson Materials</h6>
                </div>
                <div class="card-body">
                  <div id="lessonMaterials"></div>
                  {% if session.user_type == 'lecturer' or session.user_type == 'admin' %}
                  <div class="mt-3">
                    <a href="{{ url_for('add_lesson_page', unit_id=unit.id) }}" class="btn btn-sm btn-outline-primary w-100" target="_blank">
                      Edit Lesson
                    </a>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          <div id="lessonDescription" class="mt-3"></div>
        </div>

        <!-- Quiz Content -->
        <div id="quizContent" class="d-none">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <span id="quizInstructions">Complete the quiz to test your understanding.</span>
          </div>
          <div id="quizQuestions" class="mb-4"></div>
          <div class="d-flex justify-content-between align-items-center">
            <div id="quizProgress" class="text-muted small"></div>
            <button class="btn btn-success" id="submitQuiz" onclick="submitQuiz()">
              <i class="fas fa-paper-plane me-1"></i>Submit Quiz
            </button>
          </div>
        </div>

        <!-- Assignment Content -->
        <div id="assignmentContent" class="d-none">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-circle me-2"></i>
            Make sure to submit before the due date.
          </div>
          <h6>Assignment Instructions</h6>
          <div id="assignmentInstructions" class="mb-4 p-3 bg-light rounded"></div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header">
                  <h6 class="mb-0">Submission</h6>
                </div>
                <div class="card-body">
                  <label for="assignmentSubmission" class="form-label">Upload Your Work</label>
                  <input type="file" class="form-control mb-2" id="assignmentSubmission" multiple>
                  <textarea class="form-control mb-2" id="assignmentComments" placeholder="Add any comments (optional)" rows="3"></textarea>
                  <button class="btn btn-success w-100" id="submitAssignment" onclick="submitAssignment()">
                    <i class="fas fa-upload me-1"></i>Submit Assignment
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">Assignment Details</h6>
                </div>
                <div class="card-body">
                  <div id="assignmentDetails"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Exam Content -->
        <div id="examContent" class="d-none">
          <div class="alert alert-warning">
            <i class="fas fa-star me-2"></i>
            <strong>Final Examination</strong> - This exam covers all course materials.
          </div>
          <div class="text-center py-4">
            <i class="fas fa-graduation-cap fa-4x text-warning mb-3"></i>
            <h4>Ready for Your Final Exam?</h4>
            <p class="text-muted mb-4">This exam tests your understanding of all course concepts covered in the chapters.</p>
            <a class="btn btn-danger btn-lg" id="startExam" href="{{ url_for('exam_landing', unit_id=unit.id) }}">
              <i class="fas fa-play-circle me-2"></i>Start Exam
            </a>
          </div>
        </div>

        <!-- Welcome Content -->
        <div id="welcomeContent" class="text-center py-5">
          <i class="fas fa-book-open fa-4x text-muted mb-3"></i>
          <h4 class="text-muted">Welcome to Your Learning Journey</h4>
          <p class="text-muted mb-4">Select a lesson, quiz, or assignment from the sidebar to begin learning.</p>
          <div class="row justify-content-center">
            <div class="col-md-8">
              <div class="card">
                <div class="card-body">
                  <h6>Getting Started</h6>
                  <ul class="list-unstyled text-start">
                    <li><i class="fas fa-play-circle text-primary me-2"></i>Start with lessons to learn new concepts</li>
                    <li><i class="fas fa-question-circle text-info me-2"></i>Take quizzes to test your knowledge</li>
                    <li><i class="fas fa-tasks text-warning me-2"></i>Complete assignments to apply what you've learned</li>
                    <li><i class="fas fa-star text-warning me-2"></i>Final exam unlocks after completing all content</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Completion Section -->
        <div class="mt-4 pt-3 border-top d-none" id="completionSection">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="markComplete" role="switch" onchange="markCurrentItemComplete(this.checked)">
            <label class="form-check-label" for="markComplete">
              <strong>Mark this item as completed</strong>
            </label>
          </div>
          <small class="text-muted">Check this when you've finished reviewing this content.</small>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.sticky-top {
  position: -webkit-sticky;
  position: sticky;
  z-index: 1020;
  max-height: 80vh;
  overflow-y: auto;
}
.chapter-item {
  border-left: 3px solid transparent;
  transition: all 0.3s ease;
}
.chapter-item:hover {
  border-left-color: #4e73df;
  background: #f8f9fa;
}
.chapter-title {
  font-weight: 600;
  color: #2c3e50;
  cursor: pointer;
}
.lesson-item {
  padding: 8px 12px;
  border-radius: 6px;
  transition: all 0.2s ease;
  border: 1px solid transparent;
}
.lesson-item:hover {
  background: #e9ecef;
  border-color: #dee2e6;
}
.lesson-item.text-success {
  background: #d1edff;
  border-color: #b8daff;
}
.completion-checkbox:checked {
  background-color: #28a745;
  border-color: #28a745;
}
.ratio-16x9 {
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
#welcomeContent {
  min-height: 400px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.quiz-question {
  border-left: 4px solid #4e73df;
  padding-left: 1rem;
  margin-bottom: 1.5rem;
}
.assignment-detail {
  padding: 0.5rem 0;
  border-bottom: 1px solid #eee;
}
</style>

<script>
// Global variables
let currentItem = null;
let allItems = [];

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Collect all items from chapters
  allItems = [];
  {% for chapter in chapters %}
    {% for item in chapter.items %}
      allItems.push({
        id: {{ item.id }},
        title: "{{ item.title|escapejs }}",
        type: "{{ item.type }}",
        content: `{{ item.content|escapejs }}`,
        instructions: `{{ item.instructions|escapejs }}`,
        video_url: "{{ item.video_url|default('')|escapejs }}",
        video_file: "{{ item.video_file|default('')|escapejs }}",
        duration: "{{ item.duration|default('')|escapejs }}",
        completed: {{ 'true' if item.completed else 'false' }},
        chapter_title: "{{ chapter.title|escapejs }}"
      });
    {% endfor %}
  {% endfor %}

  // Expand first chapter by default
  const firstChapter = document.querySelector('.chapter-item');
  if (firstChapter) {
    toggleChapter(firstChapter.querySelector('.chapter-title'));
  }
});

// Toggle chapter expansion
function toggleChapter(element) {
  const chapterItem = element.closest('.chapter-item');
  const chapterContent = chapterItem.querySelector('.chapter-content');
  const toggleIcon = chapterItem.querySelector('.toggle-chapter i');
  
  if (chapterContent.style.display === 'none') {
    chapterContent.style.display = 'block';
    toggleIcon.className = 'fas fa-chevron-down';
  } else {
    chapterContent.style.display = 'none';
    toggleIcon.className = 'fas fa-chevron-right';
  }
}

// Load item content into main window
function loadItemContent(item) {
  if (item.type === 'exam' && !{{ 'true' if exam_unlocked else 'false' }}) {
    showNotification('Complete all content to unlock the final exam!', 'warning');
    return;
  }

  currentItem = item;
  
  // Hide all content sections
  document.getElementById('welcomeContent').classList.add('d-none');
  document.getElementById('lessonContent').classList.add('d-none');
  document.getElementById('quizContent').classList.add('d-none');
  document.getElementById('assignmentContent').classList.add('d-none');
  document.getElementById('examContent').classList.add('d-none');
  
  // Update title
  document.getElementById('contentTitle').textContent = item.title;
  
  // Show completion section for non-exam items
  if (item.type !== 'exam') {
    document.getElementById('completionSection').classList.remove('d-none');
    document.getElementById('markComplete').checked = item.completed;
  } else {
    document.getElementById('completionSection').classList.add('d-none');
  }
  
  // Load specific content based on type
  switch(item.type) {
    case 'lesson':
      loadLesson(item);
      break;
    case 'quiz':
      loadQuiz(item);
      break;
    case 'assignment':
      loadAssignment(item);
      break;
    case 'exam':
      loadExam(item);
      break;
  }
  
  // Update navigation buttons
  updateNavigation();
  
  // Highlight active item in sidebar
  highlightActiveItem(item.id);
}

// Load lesson content
function loadLesson(item) {
  const content = document.getElementById('lessonContent');
  content.classList.remove('d-none');
  
  // Video content
  const videoContent = document.getElementById('videoContent');
  const videoFrame = document.getElementById('lessonVideo');
  
  if (item.video_url || item.video_file) {
    let videoUrl = item.video_url;
    if (item.video_file) {
      videoUrl = "{{ url_for('uploaded_file', filename='') }}" + item.video_file;
    }
    
    // Convert YouTube URLs to embed format
    if (videoUrl.includes('youtube.com/watch?v=')) {
      videoUrl = videoUrl.replace('youtube.com/watch?v=', 'youtube.com/embed/');
    } else if (videoUrl.includes('youtu.be/')) {
      videoUrl = videoUrl.replace('youtu.be/', 'youtube.com/embed/');
    }
    
    videoFrame.src = videoUrl;
    videoContent.classList.remove('d-none');
  } else {
    videoContent.classList.add('d-none');
  }
  
  // Lesson description
  const descriptionEl = document.getElementById('lessonDescription');
  descriptionEl.innerHTML = item.content ? 
    `<div class="prose">${item.content}</div>` :
    '<p class="text-muted">No content available for this lesson.</p>';
  
  // Lesson materials
  const materialsEl = document.getElementById('lessonMaterials');
  materialsEl.innerHTML = item.instructions ? 
    `<div class="prose">${item.instructions}</div>` :
    '<p class="text-muted small">No additional materials provided.</p>';
}

// Load quiz content
function loadQuiz(item) {
  const content = document.getElementById('quizContent');
  content.classList.remove('d-none');
  
  // Quiz instructions
  document.getElementById('quizInstructions').textContent = 
    item.instructions || 'Complete the quiz to test your understanding.';
  
  // Quiz questions
  const questionsEl = document.getElementById('quizQuestions');
  if (item.content) {
    try {
      const questions = JSON.parse(item.content);
      questionsEl.innerHTML = renderQuizQuestions(questions);
    } catch (e) {
      questionsEl.innerHTML = `
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Error loading quiz questions. Please try again later.
        </div>
      `;
    }
  } else {
    questionsEl.innerHTML = `
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Quiz questions will be available soon.
      </div>
    `;
  }
}

// Load assignment content
function loadAssignment(item) {
  const content = document.getElementById('assignmentContent');
  content.classList.remove('d-none');
  
  // Assignment instructions
  const instructionsEl = document.getElementById('assignmentInstructions');
  instructionsEl.innerHTML = item.instructions ? 
    `<div class="prose">${item.instructions}</div>` :
    '<p class="text-muted">Follow the assignment guidelines provided by your instructor.</p>';
  
  // Assignment details
  const detailsEl = document.getElementById('assignmentDetails');
  let detailsHtml = '<div class="assignment-details">';
  
  if (item.duration) {
    detailsHtml += `<p><strong>Estimated Time:</strong> ${item.duration}</p>`;
  }
  
  detailsHtml += '</div>';
  detailsEl.innerHTML = detailsHtml;
}

// Load exam content
function loadExam(item) {
  const content = document.getElementById('examContent');
  content.classList.remove('d-none');
}

// Render quiz questions
function renderQuizQuestions(questions) {
  if (!questions || !Array.isArray(questions)) {
    return '<div class="alert alert-warning">No questions available.</div>';
  }
  
  return questions.map((q, index) => `
    <div class="quiz-question">
      <h6>${index + 1}. ${q.text || q.question}</h6>
      <div class="options">
        ${(q.options || []).map((opt, optIndex) => `
          <div class="form-check">
            <input class="form-check-input" type="radio" name="question_${index}" id="q_${index}_${optIndex}">
            <label class="form-check-label" for="q_${index}_${optIndex}">
              ${opt.text || opt}
            </label>
          </div>
        `).join('')}
      </div>
    </div>
  `).join('');
}

// Update navigation buttons
function updateNavigation() {
  if (!currentItem) return;
  
  const currentIndex = allItems.findIndex(item => item.id === currentItem.id);
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  prevBtn.disabled = currentIndex <= 0;
  nextBtn.disabled = currentIndex >= allItems.length - 1;
}

// Navigate between items
function navigateItem(direction) {
  if (!currentItem) return;
  
  const currentIndex = allItems.findIndex(item => item.id === currentItem.id);
  const newIndex = currentIndex + direction;
  
  if (newIndex >= 0 && newIndex < allItems.length) {
    const nextItem = allItems[newIndex];
    
    // Skip locked exams
    if (nextItem.type === 'exam' && !{{ 'true' if exam_unlocked else 'false' }}) {
      if (direction > 0) {
        navigateItem(1); // Skip to next
      } else {
        navigateItem(-1); // Skip to previous
      }
      return;
    }
    
    loadItemContent(nextItem);
  }
}

// Mark current item as complete
function markCurrentItemComplete(completed) {
  if (!currentItem || currentItem.type === 'exam') return;
  
  updateItemProgress(currentItem.id, completed, {{ unit.id }});
}

// Update item progress
function updateItemProgress(itemId, completed, unitId) {
  fetch("{{ url_for('update_progress') }}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      unit_id: unitId,
      item_id: itemId,
      completed: completed
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update UI
      const itemElement = document.querySelector(`.lesson-item[data-item-id="${itemId}"]`);
      if (itemElement) {
        if (completed) {
          itemElement.classList.add('text-success');
        } else {
          itemElement.classList.remove('text-success');
        }
      }
      
      // Update current item status
      if (currentItem && currentItem.id === itemId) {
        currentItem.completed = completed;
      }
      
      showNotification(completed ? 'Item marked as completed!' : 'Item marked as incomplete.', 'success');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Error updating progress.', 'error');
  });
}

// Highlight active item in sidebar
function highlightActiveItem(itemId) {
  // Remove active class from all items
  document.querySelectorAll('.lesson-item').forEach(item => {
    item.classList.remove('active');
    item.style.backgroundColor = '';
  });
  
  // Add active class to current item
  const activeItem = document.querySelector(`.lesson-item[data-item-id="${itemId}"]`);
  if (activeItem) {
    activeItem.classList.add('active');
    activeItem.style.backgroundColor = '#e3f2fd';
  }
}

// Show notification
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  // Add to page
  document.body.appendChild(notification);
  
  // Auto remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
}

// Placeholder functions for form submissions
function submitQuiz() {
  showNotification('Quiz submission functionality coming soon!', 'info');
}

function submitAssignment() {
  showNotification('Assignment submission functionality coming soon!', 'info');
}
</script>
{% endblock %}
