{# templates/learning_interface.html #}
{% extends "base.html" %}
{% block content %}
<div class="row">
  <!-- Sidebar -->
  <div class="col-md-4 col-lg-3">
    <div class="card sticky-top" style="top:20px;">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0">Course Content</h6>
      </div>

      <div class="card-body p-0">
        <div class="list-group list-group-flush" id="courseChapters">
          {% for chapter in chapters %}
          {% set chapter_id = chapter.id if chapter is mapping else chapter[0] if chapter is iterable and chapter is not string else 0 %}
          {% set chapter_title = chapter.title if chapter is mapping else chapter[1] if chapter is iterable and chapter is not string and chapter|length > 1 else "Chapter " ~ loop.index %}
          {% set chapter_description = chapter.description if chapter is mapping else chapter[2] if chapter is iterable and chapter is not string and chapter|length > 2 else "" %}
          
          <div class="list-group-item chapter-item" data-chapter-id="{{ chapter_id }}">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 chapter-title" role="button" onclick="toggleChapter(this)">
                <i class="fas fa-folder me-2"></i>{{ chapter_title }}
                {% if chapter_description %}
                <small class="text-muted d-block mt-1">{{ chapter_description }}</small>
                {% endif %}
              </h6>
              <button class="btn btn-sm btn-link toggle-chapter" onclick="toggleChapter(this)">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>

            <div class="chapter-content mt-2 ms-3" style="display: none;">
              {% set chapter_items = [] %}
              {% if chapter is mapping %}
                {% if chapter.items is defined and chapter.items is iterable and chapter.items is not string %}
                  {% set chapter_items = chapter.items %}
                {% elif chapter.get('items') is defined and chapter.get('items') is iterable and chapter.get('items') is not string %}
                  {% set chapter_items = chapter.get('items', []) %}
                {% endif %}
              {% endif %}

              {% if chapter_items and chapter_items|length > 0 %}
                {% for item in chapter_items %}
                  {% set is_exam = false %}
                  {% set item_id = 0 %}
                  {% set item_title = "Untitled Item" %}
                  {% set item_type = "lesson" %}
                  {% set item_completed = false %}
                  {% set item_duration = "" %}
                  
                  {% if item is mapping %}
                    {% set is_exam = (item.type == 'exam') if item.type is defined else false %}
                    {% set item_id = item.id if item.id is defined else 0 %}
                    {% set item_title = item.title if item.title is defined else "Untitled Item" %}
                    {% set item_type = item.type if item.type is defined else "lesson" %}
                    {% set item_completed = item.completed if item.completed is defined else false %}
                    {% set item_duration = item.duration if item.duration is defined else "" %}
                  {% elif item is iterable and item is not string %}
                    {% set is_exam = (item[4] == 'exam') if item|length > 4 else false %}
                    {% set item_id = item[0] if item|length > 0 else 0 %}
                    {% set item_title = item[1] if item|length > 1 else "Untitled Item" %}
                    {% set item_type = item[4] if item|length > 4 else "lesson" %}
                    {% set item_completed = false %}
                    {% set item_duration = item[8] if item|length > 8 else "" %}
                  {% endif %}
                  
                  <div
                    class="d-flex align-items-start mb-2 lesson-item {% if item_completed %}text-success{% endif %} {% if is_exam and not exam_unlocked %}text-muted{% endif %}"
                    data-item-id="{{ item_id }}"
                    data-type="{{ item_type }}"
                    data-locked="{{ (is_exam and not exam_unlocked)|int }}"
                    onclick="loadItemContent(this)"
                    style="cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: all 0.2s ease; border:1px solid transparent;"
                    onmouseover="this.style.backgroundColor='#f8f9fa'" 
                    onmouseout="this.style.backgroundColor='transparent'"
                  >
                    <div class="form-check me-2 {% if is_exam %}d-none{% endif %}">
                      <input class="form-check-input completion-checkbox" type="checkbox"
                             {% if item_completed %}checked{% endif %}
                             {% if is_exam and not exam_unlocked %}disabled{% endif %}
                             data-item-id="{{ item_id }}"
                             onclick="event.stopPropagation(); updateItemProgress({{ item_id }}, this.checked, {{ unit.id }})">
                    </div>

                    <div class="flex-grow-1">
                      <div class="d-flex justify-content-between">
                        <small>
                          {% if is_exam %}
                            {% if exam_unlocked %}
                            <i class="fas fa-star text-warning me-1"></i>
                            <strong>Final Exam</strong>
                            {% else %}
                            <i class="fas fa-lock me-1"></i>
                            <span class="text-muted">Final Exam (Complete all content first)</span>
                            {% endif %}
                          {% else %}
                            <i class="fas {% if item_type == 'quiz' %}fa-question-circle text-info{% elif item_type == 'assignment' %}fa-tasks text-warning{% else %}fa-play-circle text-primary{% endif %} me-1"></i>
                            <span class="item-title">{{ item_title }}</span>
                          {% endif %}
                        </small>
                        {% if item_duration and not is_exam %}
                        <small class="text-muted ms-2">{{ item_duration }}</small>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="text-muted small">No items available in this chapter</div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="card-footer">
        <div class="progress mb-2" style="height:8px;">
          <div class="progress-bar bg-success"
               role="progressbar"
               style="width: {{ progress_percentage }}%;"
               aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <small class="text-muted">
          Your Progress: {{ completed_items }}/{{ total_items }} ({{ progress_percentage }}%)
        </small>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="col-md-8 col-lg-9">
    <div class="card mb-4">
      <div class="card-body">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('student_dashboard') }}">My Courses</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('unit_detail', unit_id=unit.id) }}">{{ unit.title }}</a></li>
            <li class="breadcrumb-item active">Learning</li>
          </ol>
        </nav>
        <h4 class="card-title">{{ unit.title }}</h4>
        <p class="text-muted">{{ unit.description or "Course content and materials" }}</p>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0" id="contentTitle">Welcome to Your Learning Journey</h5>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-2" id="prevBtn" onclick="navigateItem(-1)" disabled>
              <i class="fas fa-chevron-left me-1"></i>Previous
            </button>
            <button class="btn btn-sm btn-primary" id="nextBtn" onclick="navigateItem(1)" disabled>
              Next<i class="fas fa-chevron-right ms-1"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="card-body">
        <!-- Lesson Content -->
        <div id="lessonContent" class="d-none">
          <div class="row">
            <div class="col-lg-8">
              <div id="videoContent" class="mb-4 d-none">
                <div class="ratio ratio-16x9 mb-3">
                  <iframe id="lessonVideo" src="" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
                </div>
              </div>
              <div id="lessonDescription" class="prose"></div>
            </div>
            <div class="col-lg-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">Lesson Materials</h6>
                </div>
                <div class="card-body">
                  <div id="lessonMaterials"></div>
                  {% if session.user_type == 'lecturer' or session.user_type == 'admin' %}
                  <div class="mt-3">
                    <a href="{{ url_for('add_lesson_page', unit_id=unit.id) }}" class="btn btn-sm btn-outline-primary w-100" target="_blank">
                      Edit Lesson
                    </a>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quiz Content -->
        <div id="quizContent" class="d-none">
          <div class="alert alert-info d-flex align-items-center">
            <i class="fas fa-info-circle me-2"></i>
            <span id="quizInstructions">Complete the quiz to test your understanding.</span>
          </div>
          <form id="quizForm">
            <div id="quizQuestions" class="mb-4"></div>
            <div class="d-flex justify-content-between align-items-center">
              <div id="quizProgress" class="text-muted small"></div>
              <button class="btn btn-success" id="submitQuizBtn" type="submit">
                <i class="fas fa-paper-plane me-1"></i>Submit Quiz
              </button>
            </div>
          </form>
        </div>

        <!-- Assignment Content -->
        <div id="assignmentContent" class="d-none">
          <div class="alert alert-warning d-flex align-items-center">
            <i class="fas fa-exclamation-circle me-2"></i>
            <div>
              <div><strong id="assignmentTitleShort">Assignment</strong></div>
              <small id="assignmentDueMeta" class="text-muted"></small>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">Submission</h6>
                </div>
                <div class="card-body">
                  <form id="assignmentForm">
                    <label for="assignmentFiles" class="form-label">Upload Your Work</label>
                    <input type="file" class="form-control mb-2" id="assignmentFiles" name="files" multiple>
                    <textarea class="form-control mb-2" id="assignmentComments" name="comments" placeholder="Add any comments (optional)" rows="3"></textarea>
                    <button class="btn btn-success w-100" id="submitAssignmentBtn" type="submit">
                      <i class="fas fa-upload me-1"></i>Submit Assignment
                    </button>
                  </form>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">Assignment Details</h6>
                </div>
                <div class="card-body" id="assignmentDetails"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Exam Content -->
        <div id="examContent" class="d-none">
          <div class="alert alert-warning">
            <i class="fas fa-star me-2"></i>
            <strong>Final Examination</strong> - This exam covers all course materials.
          </div>
          <div class="text-center py-4">
            <i class="fas fa-graduation-cap fa-4x text-warning mb-3"></i>
            <h4>Ready for Your Final Exam?</h4>
            <p class="text-muted mb-4">This exam tests your understanding of all course concepts covered in the chapters.</p>
            <a class="btn btn-danger btn-lg" id="startExam" href="{{ url_for('exam_landing', unit_id=unit.id) }}">
              <i class="fas fa-play-circle me-2"></i>Start Exam
            </a>
          </div>
        </div>

        <!-- Welcome Content -->
        <div id="welcomeContent" class="text-center py-5">
          <i class="fas fa-book-open fa-4x text-muted mb-3"></i>
          <h4 class="text-muted">Welcome to Your Learning Journey</h4>
          <p class="text-muted mb-4">Select a lesson, quiz, or assignment from the sidebar to begin learning.</p>
        </div>

        <!-- Completion Section -->
        <div class="mt-4 pt-3 border-top d-none" id="completionSection">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="markComplete" role="switch" onchange="markCurrentItemComplete(this.checked)">
            <label class="form-check-label" for="markComplete">
              <strong>Mark this item as completed</strong>
            </label>
          </div>
          <small class="text-muted">Check this when you've finished reviewing this content.</small>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.sticky-top{position:-webkit-sticky;position:sticky;z-index:1020;max-height:80vh;overflow-y:auto}
.chapter-item{border-left:3px solid transparent;transition:all .3s ease}
.chapter-item:hover{border-left-color:#4e73df;background:#f8f9fa}
.chapter-title{font-weight:600;color:#2c3e50;cursor:pointer}
.lesson-item{padding:8px 12px;border-radius:6px;transition:all .2s ease;border:1px solid transparent}
.lesson-item:hover{background:#e9ecef;border-color:#dee2e6}
.lesson-item.active{background-color:#e3f2fd!important;border-color:#2196f3!important}
.completion-checkbox:checked{background-color:#28a745;border-color:#28a745}
.ratio-16x9{border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.quiz-question{border-left:4px solid #4e73df;padding-left:1rem;margin-bottom:1.25rem}
.assignment-detail{padding:.5rem 0;border-bottom:1px solid #eee}
.prose{line-height:1.6}
.prose p{margin-bottom:1rem}
</style>

<script>
let currentItem = null;
let allItems = [];
const UNIT_ID = {{ unit.id }};

document.addEventListener('DOMContentLoaded', () => {
  // Build flat list for navigation
  allItems = Array.from(document.querySelectorAll('.lesson-item')).map(el => ({
    id: Number(el.dataset.itemId),
    type: el.dataset.type,
    title: (el.querySelector('.item-title')?.textContent || '').trim() || 'Untitled',
    locked: el.dataset.locked === '1'
  }));

  // Auto-expand first chapter that has items
  const firstChapter = document.querySelector('.chapter-item');
  if (firstChapter) toggleChapter(firstChapter.querySelector('.chapter-title'));
});

function toggleChapter(el){
  const wrap = el.closest('.chapter-item');
  const body = wrap.querySelector('.chapter-content');
  const icon = wrap.querySelector('.toggle-chapter i');
  const open = body.style.display !== 'block';
  body.style.display = open ? 'block' : 'none';
  icon.className = open ? 'fas fa-chevron-down' : 'fas fa-chevron-right';
}

// ===== Item Loading =====
async function loadItemContent(element){
  const itemId = Number(element.dataset.itemId);
  const itemType = element.dataset.type;
  const locked = element.dataset.locked === '1';
  const title = (element.querySelector('.item-title')?.textContent || 'Item').trim();

  if (itemType === 'exam' && locked){
    showNotification('Complete all content to unlock the final exam!', 'warning');
    return;
  }

  highlightActiveItem(itemId);
  currentItem = { id: itemId, type: itemType, title, locked };

  setTitle(title);
  hideAllSections();
  showCompletion(itemType !== 'exam');
  setNavEnabled(true);

  // Fetch details
  let data = null;
  try {
    const res = await fetch(`/api/unit/${UNIT_ID}/item/${itemId}`);
    const ct = res.headers.get('content-type') || '';
    if (!ct.includes('application/json')) throw new Error('Non-JSON response');
    data = await res.json();
  } catch (e){
    console.warn('Detail fetch failed:', e);
  }

  const detail = (data && data.ok && data.item) ? data.item : { type: itemType, title };

  switch((detail.type || itemType)){
    case 'lesson': renderLesson(detail); break;
    case 'quiz': renderQuiz(detail); break;
    case 'assignment': renderAssignment(detail); break;
    case 'exam': document.getElementById('examContent').classList.remove('d-none'); break;
    default: renderLesson(detail);
  }
}

// ===== Rendering helpers =====
function setTitle(t){ document.getElementById('contentTitle').textContent = t || 'Item'; }
function hideAllSections(){
  ['welcomeContent','lessonContent','quizContent','assignmentContent','examContent'].forEach(id=>{
    document.getElementById(id).classList.add('d-none');
  });
}
function showCompletion(show){
  const sec = document.getElementById('completionSection');
  sec.classList.toggle('d-none', !show);
  if (show) {
    // sync checkbox state from sidebar
    const itemEl = document.querySelector(`.lesson-item[data-item-id="${currentItem.id}"]`);
    document.getElementById('markComplete').checked = itemEl?.classList.contains('text-success') || false;
  }
}
function setNavEnabled(enabled){
  document.getElementById('prevBtn').disabled = !enabled;
  document.getElementById('nextBtn').disabled = !enabled;
}
function highlightActiveItem(itemId){
  document.querySelectorAll('.lesson-item').forEach(el=>el.classList.remove('active'));
  const el = document.querySelector(`.lesson-item[data-item-id="${itemId}"]`);
  if (el) el.classList.add('active');
}

// LESSON
function renderLesson(d){
  const wrap = document.getElementById('lessonContent');
  wrap.classList.remove('d-none');

  // Video (url or embed)
  const vwrap = document.getElementById('videoContent');
  const iframe = document.getElementById('lessonVideo');
  const vurl = d.video_url || '';
  if (vurl){
    iframe.src = vurl;
    vwrap.classList.remove('d-none');
  } else {
    iframe.src = '';
    vwrap.classList.add('d-none');
  }

  // Description / content (HTML allowed; fallback to text)
  const desc = document.getElementById('lessonDescription');
  const html = d.content_html || d.content || '';
  desc.innerHTML = html ? html : `
    <div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>
      Lesson content will appear here once added.
    </div>
  `;

  // Materials list
  const mat = document.getElementById('lessonMaterials');
  const files = Array.isArray(d.attachments) ? d.attachments : [];
  if (files.length){
    mat.innerHTML = files.map(f => `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="small text-truncate" title="${f.name || 'File'}"><i class="fas fa-file me-2"></i>${f.name || 'File'}</span>
        <a class="btn btn-sm btn-outline-primary" href="${f.url || '#'}" target="_blank">Download</a>
      </div>
    `).join('');
  } else {
    mat.innerHTML = `<p class="text-muted small mb-0">No materials uploaded yet.</p>`;
  }
}

// QUIZ
function renderQuiz(d){
  const panel = document.getElementById('quizContent');
  panel.classList.remove('d-none');

  document.getElementById('quizInstructions').textContent =
    d.instructions || 'Complete the quiz to test your understanding.';

  const questions = Array.isArray(d.questions) ? d.questions : [];
  const qWrap = document.getElementById('quizQuestions');
  if (!questions.length){
    qWrap.innerHTML = `
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>No questions yet. The lecturer hasn’t added any.
      </div>`;
  } else {
    qWrap.innerHTML = questions.map((q, i) => {
      const opts = Array.isArray(q.options) ? q.options : [];
      const name = `q_${i}`;
      return `
        <div class="quiz-question">
          <h6>${i+1}. ${escapeHTML(q.text || 'Question')}</h6>
          <div class="options">
            ${opts.map((op, j)=>`
              <div class="form-check">
                <input class="form-check-input" type="radio" name="${name}" id="${name}_${j}" value="${escapeHTML(op.value ?? String(j))}">
                <label class="form-check-label" for="${name}_${j}">${escapeHTML(op.text || op)}</label>
              </div>`).join('')}
          </div>
        </div>`;
    }).join('');
  }

  // Progress text
  document.getElementById('quizProgress').textContent = d.total_points
    ? `Total points: ${d.total_points}`
    : '';

  // Submit handler
  const form = document.getElementById('quizForm');
  form.onsubmit = async (e)=>{
    e.preventDefault();
    const payload = {
      unit_id: UNIT_ID,
      item_id: currentItem.id,
      answers: []
    };
    const qs = qWrap.querySelectorAll('.quiz-question');
    qs.forEach((qEl, idx)=>{
      const checked = qEl.querySelector(`input[name="q_${idx}"]:checked`);
      payload.answers.push({ index: idx, value: checked ? checked.value : null });
    });

    const submitUrl = d.submit_url || `/api/unit/${UNIT_ID}/quiz/${currentItem.id}/submit`;
    try{
      const res = await fetch(submitUrl, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await safeJson(res);
      if (result && (result.ok || result.success)){
        showNotification(result.message || 'Quiz submitted successfully!', 'success');
      } else {
        showNotification((result && (result.error || result.message)) || 'Failed to submit quiz.', 'danger');
      }
    }catch(err){
      showNotification('Network error submitting quiz.', 'danger');
    }
  };
}

// ASSIGNMENT
function renderAssignment(d){
  const panel = document.getElementById('assignmentContent');
  panel.classList.remove('d-none');

  document.getElementById('assignmentTitleShort').textContent = d.title || 'Assignment';
  document.getElementById('assignmentDueMeta').textContent = d.due_at ? `Due: ${d.due_at}` : '';

  // Instructions/details
  const details = document.getElementById('assignmentDetails');
  const rows = [];
  if (d.points) rows.push(row('Points', d.points));
  if (d.submission_format) rows.push(row('Submission', d.submission_format));
  if (d.passing_score) rows.push(row('Passing Score', d.passing_score + '%'));
  if (Array.isArray(d.attachments) && d.attachments.length){
    rows.push(`<div class="assignment-detail"><strong>Files:</strong><div class="mt-2">${d.attachments.map(f=>`
      <a href="${f.url || '#'}" class="btn btn-sm btn-outline-primary me-2 mb-2" target="_blank">
        <i class="fas fa-file me-1"></i>${escapeHTML(f.name || 'File')}
      </a>`).join('')}</div></div>`);
  }
  if (d.instructions){
    rows.unshift(`<div class="assignment-detail"><strong>Instructions</strong><div class="mt-2">${d.instructions}</div></div>`);
  }
  details.innerHTML = rows.join('') || `<p class="text-muted mb-0">No details available.</p>`;

  // Submit handler
  const form = document.getElementById('assignmentForm');
  form.onsubmit = async (e)=>{
    e.preventDefault();
    const fd = new FormData();
    const files = document.getElementById('assignmentFiles').files;
    for (const f of files) fd.append('files', f);
    fd.append('comments', document.getElementById('assignmentComments').value || '');
    fd.append('unit_id', String(UNIT_ID));
    fd.append('item_id', String(currentItem.id));

    const submitUrl = d.submit_url || `/api/unit/${UNIT_ID}/assignment/${currentItem.id}/submit`;
    try{
      const res = await fetch(submitUrl, { method:'POST', body: fd });
      const result = await safeJson(res);
      if (result && (result.ok || result.success)){
        showNotification(result.message || 'Assignment submitted successfully!', 'success');
      } else {
        showNotification((result && (result.error || result.message)) || 'Failed to submit assignment.', 'danger');
      }
    }catch(err){
      showNotification('Network error submitting assignment.', 'danger');
    }
  };

  function row(label, value){
    return `<div class="assignment-detail"><strong>${escapeHTML(label)}:</strong> <span class="text-muted">${escapeHTML(String(value))}</span></div>`;
  }
}

// ===== Navigation & Progress =====
function navigateItem(direction){
  if (!currentItem) return;
  const idx = allItems.findIndex(i=>i.id===currentItem.id);
  let next = idx + direction;

  while (next >=0 && next < allItems.length){
    const candidate = allItems[next];
    // Skip locked exams
    if (candidate.type === 'exam' && candidate.locked){
      next += direction;
      continue;
    }
    const el = document.querySelector(`.lesson-item[data-item-id="${candidate.id}"]`);
    if (el){ loadItemContent(el); }
    break;
  }
}

function markCurrentItemComplete(completed){
  if (!currentItem || currentItem.type === 'exam') return;
  updateItemProgress(currentItem.id, completed, UNIT_ID);
}

function updateItemProgress(itemId, completed, unitId){
  fetch("{{ url_for('update_progress') }}", {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ unit_id: unitId, item_id: itemId, completed })
  })
  .then(res=>res.json())
  .then(data=>{
    if (data && data.success){
      const el = document.querySelector(`.lesson-item[data-item-id="${itemId}"]`);
      if (el){
        el.classList.toggle('text-success', completed);
        const cb = el.querySelector('.completion-checkbox');
        if (cb) cb.checked = completed;
      }
      updateProgressDisplay();
      showNotification(completed ? 'Item marked as completed!' : 'Item marked as incomplete.', 'success');
    }
  })
  .catch(()=>showNotification('Error updating progress.', 'danger'));
}

function updateProgressDisplay(){
  const completed = document.querySelectorAll('.lesson-item.text-success').length;
  const total = document.querySelectorAll('.lesson-item').length;
  const pct = total ? Math.round((completed/total)*100) : 0;
  const bar = document.querySelector('.progress-bar');
  if (bar){
    bar.style.width = pct + '%';
    bar.setAttribute('aria-valuenow', pct);
  }
  const txt = document.querySelector('.card-footer small');
  if (txt){
    txt.textContent = `Your Progress: ${completed}/${total} (${pct}%)`;
  }
}

// ===== Utilities =====
function showNotification(message, type='info'){
  const div = document.createElement('div');
  div.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  div.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  div.innerHTML = `${escapeHTML(message)} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
  document.body.appendChild(div);
  setTimeout(()=>div.remove(), 5000);
}
function escapeHTML(s){ return (s??'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
async function safeJson(res){ try{ return await res.json(); } catch{ return null; } }
</script>
{% endblock %}
