{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-md-12">
      <h1 class="h3 mb-0">HBI Virtual Campus</h1>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row">
    <div class="col-md-12">
      <h2 class="h4 mb-4">Curriculum</h2>

      <!-- Course Title Section -->
      <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
          <h3 class="card-title text-uppercase fw-bold mb-2" style="color: #2c3e50; font-size: 1.1rem;">
            {{ unit.title if unit else "INTRODUCTION TO PROGRAMMING" }}
          </h3>
          <p class="card-text text-muted mb-0 small">
            {{ unit.description or "Course description will appear here" }}
          </p>
        </div>
      </div>

      <!-- Curriculum Items -->
      <div id="curriculumList" class="mb-4">
        <!-- Filled by JS -->
      </div>

      <!-- Add Chapter Button -->
      <div class="text-center mt-4">
        <button id="btnAddChapter" class="btn btn-primary btn-sm">
          + Add Chapter
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Lesson Modal -->
<div class="modal fade" id="lessonModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form class="modal-content" id="lessonForm" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title">Add Lesson</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="chapter_id" id="lesson_chapter_id">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input name="title" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Description / Notes</label>
          <textarea name="description" class="form-control" rows="4"></textarea>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">YouTube URL (optional)</label>
            <input name="video_url" class="form-control" placeholder="https://youtube.com/...">
          </div>
          <div class="col-md-6">
            <label class="form-label">Upload Video (optional)</label>
            <input type="file" name="video_file" class="form-control" accept="video/*">
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label">Upload Lesson Notes (PDF/Doc, optional)</label>
          <input type="file" name="notes_file" class="form-control" accept=".pdf,.doc,.docx,.ppt,.pptx">
        </div>
        <div class="mt-3">
          <label class="form-label">Estimated Duration (e.g., 15m)</label>
          <input name="duration" class="form-control" placeholder="15m">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
        <button class="btn btn-primary" type="submit">Save Lesson</button>
      </div>
    </form>
  </div>
</div>

<!-- Quiz Modal -->
<div class="modal fade" id="quizModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="quizForm" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title">Add Quiz</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="chapter_id" id="quiz_chapter_id">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input name="title" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control" rows="3"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Duration (e.g., 10m)</label>
          <input name="duration" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">Upload Quiz File (optional)</label>
          <input type="file" name="attachment" class="form-control" accept=".pdf,.doc,.docx">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
        <button class="btn btn-primary" type="submit">Save Quiz</button>
      </div>
    </form>
  </div>
</div>

<!-- Assignment Modal -->
<div class="modal fade" id="assignmentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="assignmentForm" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title">Add Assignment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="chapter_id" id="assignment_chapter_id">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input name="title" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Instructions</label>
          <textarea name="instructions" class="form-control" rows="4"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Due/Duration (optional)</label>
          <input name="duration" class="form-control" placeholder="e.g., Due week 3">
        </div>
        <div class="mb-3">
          <label class="form-label">Upload Attachment (optional)</label>
          <input type="file" name="attachment" class="form-control" accept=".pdf,.doc,.docx,.zip">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
        <button class="btn btn-primary" type="submit">Save Assignment</button>
      </div>
    </form>
  </div>
</div>

<style>
/* Main styling to match the design */
.card {
  border: none;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 1rem;
}

.card-title {
  color: #2c3e50;
  font-weight: 600;
  font-size: 1.1rem;
}

.card-text {
  color: #7f8c8d;
  font-size: 0.875rem;
}

.chapter-card {
  border-left: 4px solid #4e73df;
  transition: all 0.3s ease;
}

.chapter-card:hover {
  transform: translateX(2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.chapter-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
}

.chapter-title {
  color: #2c3e50;
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.chapter-description {
  color: #7f8c8d;
  font-size: 0.875rem;
}

.item-card {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 0.75rem;
  margin-bottom: 0.5rem;
}

.item-type {
  font-weight: 600;
  color: #4e73df;
  font-size: 0.875rem;
  text-transform: capitalize;
}

.item-title {
  color: #2c3e50;
  font-size: 0.9rem;
  margin-bottom: 0.25rem;
}

.item-duration {
  color: #7f8c8d;
  font-size: 0.8rem;
}

.btn-group .btn {
  font-size: 0.8rem;
  padding: 0.25rem 0.5rem;
  margin-left: 0.25rem;
}

.btn-primary {
  background-color: #4e73df;
  border-color: #4e73df;
}

.btn-primary:hover {
  background-color: #2e59d9;
  border-color: #2e59d9;
}

/* Header styling */
h1 {
  color: #2c3e50;
  font-weight: 700;
}

h2 {
  color: #2c3e50;
  font-weight: 600;
  border-bottom: 2px solid #4e73df;
  padding-bottom: 0.5rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const unitId = {{ unit.id if unit else 0 }};
  const curriculumEl = document.getElementById('curriculumList');

  const lessonModal = new bootstrap.Modal(document.getElementById('lessonModal'));
  const quizModal = new bootstrap.Modal(document.getElementById('quizModal'));
  const assignmentModal = new bootstrap.Modal(document.getElementById('assignmentModal'));

  // Render curriculum
  async function loadCurriculum() {
    const res = await fetch(`{{ url_for('api_get_curriculum', unit_id=0) }}`.replace('0', unitId));
    const json = await res.json();
    if (!json.ok) return;
    const chapters = json.chapters || [];

    curriculumEl.innerHTML = '';
    chapters.forEach(ch => {
      const card = document.createElement('div');
      card.className = 'card chapter-card';
      card.innerHTML = `
        <div class="card-body">
          <div class="chapter-header">
            <div>
              <h6 class="chapter-title">+ ${escapeHtml(ch.title)}</h6>
              <small class="chapter-description">${escapeHtml(ch.description || '')}</small>
            </div>
            <div class="btn-group">
              <button class="btn btn-outline-primary btn-sm add-lesson" data-ch="${ch.id}">Lesson</button>
              <button class="btn btn-outline-primary btn-sm add-quiz" data-ch="${ch.id}">Quiz</button>
              <button class="btn btn-outline-primary btn-sm add-assignment" data-ch="${ch.id}">Assignment</button>
            </div>
          </div>
          <div class="curriculum-items">
            ${(ch.items || []).map(it => `
              <div class="item-card">
                <div class="item-type">${it.type}</div>
                <div class="item-title">${escapeHtml(it.title)}</div>
                ${it.duration ? `<div class="item-duration">${escapeHtml(it.duration)}</div>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `;
      curriculumEl.appendChild(card);
    });

    // Hook buttons
    curriculumEl.querySelectorAll('.add-lesson').forEach(b => b.addEventListener('click', () => {
      document.getElementById('lesson_chapter_id').value = b.dataset.ch;
      document.getElementById('lessonForm').reset();
      lessonModal.show();
    }));
    curriculumEl.querySelectorAll('.add-quiz').forEach(b => b.addEventListener('click', () => {
      document.getElementById('quiz_chapter_id').value = b.dataset.ch;
      document.getElementById('quizForm').reset();
      quizModal.show();
    }));
    curriculumEl.querySelectorAll('.add-assignment').forEach(b => b.addEventListener('click', () => {
      document.getElementById('assignment_chapter_id').value = b.dataset.ch;
      document.getElementById('assignmentForm').reset();
      assignmentModal.show();
    }));
  }

  // Add chapter
  document.getElementById('btnAddChapter').addEventListener('click', async () => {
    const title = prompt('Enter chapter title (leave blank for automatic):', '');
    const form = new FormData();
    if (title) form.append('title', title);
    const res = await fetch(`{{ url_for('api_create_chapter', unit_id=0) }}`.replace('0', unitId), {
      method: 'POST',
      body: form
    });
    const json = await res.json();
    if (json.ok) {
      await loadCurriculum();
    } else {
      alert(json.error || 'Failed to add chapter');
    }
  });

  // Submit lesson
  document.getElementById('lessonForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    fd.append('type', 'lesson');
    const res = await fetch(`{{ url_for('api_create_item', unit_id=0) }}`.replace('0', unitId), { method:'POST', body: fd });
    const json = await res.json();
    if (json.ok) {
      lessonModal.hide();
      await loadCurriculum();
    } else alert(json.error || 'Failed to save lesson');
  });

  // Submit quiz
  document.getElementById('quizForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    fd.append('type', 'quiz');
    const res = await fetch(`{{ url_for('api_create_item', unit_id=0) }}`.replace('0', unitId), { method:'POST', body: fd });
    const json = await res.json();
    if (json.ok) {
      quizModal.hide();
      await loadCurriculum();
    } else alert(json.error || 'Failed to save quiz');
  });

  // Submit assignment
  document.getElementById('assignmentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    fd.append('type', 'assignment');
    const res = await fetch(`{{ url_for('api_create_item', unit_id=0) }}`.replace('0', unitId), { method:'POST', body: fd });
    const json = await res.json();
    if (json.ok) {
      assignmentModal.hide();
      await loadCurriculum();
    } else alert(json.error || 'Failed to save assignment');
  });

  function escapeHtml(s) {
    return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Initial load
  loadCurriculum();
});
</script>
{% endblock %}
