{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-md-12">
      <h1 class="h3 mb-0">HBI Virtual Campus</h1>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row">
    <div class="col-md-12">
      <h2 class="h4 mb-4">Curriculum</h2>

      <!-- Course Title Section -->
      <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
          <h3 class="card-title text-uppercase fw-bold mb-2" style="color: #2c3e50; font-size: 1.1rem;">
            {{ unit.title if unit else "INTRODUCTION TO PROGRAMMING" }}
          </h3>
          <p class="card-text text-muted mb-0 small">
            {{ unit.description or "Course description will appear here" }}
          </p>
        </div>
      </div>

      <!-- Current Chapter Items (Temporary) -->
      <div id="currentChapterItems" class="mb-4" style="display: none;">
        <div class="card mb-4">
          <div class="card-header bg-light">
            <h5 class="mb-0">Current Chapter Items</h5>
          </div>
          <div class="card-body">
            <div id="lessonList" class="mb-3">
              <h6 class="text-muted">Lessons</h6>
              <!-- Lessons will be added here -->
            </div>
            <div id="quizList" class="mb-3">
              <h6 class="text-muted">Quizzes</h6>
              <!-- Quizzes will be added here -->
            </div>
            <div id="assignmentList" class="mb-3">
              <h6 class="text-muted">Assignments</h6>
              <!-- Assignments will be added here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Add Content Boxes -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card text-center h-100">
            <div class="card-body">
              <h5 class="card-title">Lesson</h5>
              <p class="card-text text-muted small">Add learning materials and content</p>
              <a href="{{ url_for('add_lesson') }}" class="btn btn-outline-primary btn-sm">
                + Add Lesson
              </a>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center h-100">
            <div class="card-body">
              <h5 class="card-title">Quiz</h5>
              <p class="card-text text-muted small">Create assessment questions</p>
              <a href="{{ url_for('add_quiz') }}" class="btn btn-outline-primary btn-sm">
                + Add Quiz
              </a>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center h-100">
            <div class="card-body">
              <h5 class="card-title">Assignment</h5>
              <p class="card-text text-muted small">Create tasks for students</p>
              <a href="{{ url_for('add_assignment') }}" class="btn btn-outline-primary btn-sm">
                + Add Assignment
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Save Chapter Button -->
      <div class="text-center mb-4">
        <button id="btnSaveChapter" class="btn btn-primary" disabled>
          Save Chapter
        </button>
      </div>

      <!-- Saved Chapters List -->
      <div id="savedChaptersList" class="mb-4">
        <!-- Saved chapters will appear here -->
      </div>

      <!-- Add New Chapter Button -->
      <div class="text-center mb-4">
        <button id="btnNewChapter" class="btn btn-outline-primary">
          + Add New Chapter
        </button>
      </div>

      <!-- Final Exam Section (Shows after 10 chapters) -->
      <div id="finalExamSection" class="text-center" style="display: none;">
        <div class="card border-success">
          <div class="card-body">
            <h5 class="card-title text-success">Final Exam</h5>
            <p class="card-text text-muted">You can now upload the final exam for this course</p>
            <a href="{{ url_for('add_exam') }}" class="btn btn-success">
              + Upload Final Exam
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.card {
  border: none;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.chapter-card {
  border-left: 4px solid #4e73df;
}

.item-badge {
  background: #e3f2fd;
  color: #1976d2;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 500;
}

.current-item {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 0.75rem;
  margin-bottom: 0.5rem;
}

.btn-primary {
  background-color: #4e73df;
  border-color: #4e73df;
}

.btn-primary:hover {
  background-color: #2e59d9;
  border-color: #2e59d9;
}

.btn-success {
  background-color: #28a745;
  border-color: #28a745;
}

.btn-success:hover {
  background-color: #218838;
  border-color: #1e7e34;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.border-success {
  border: 2px solid #28a745 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const unitId = {{ unit.id if unit else 0 }};
  let currentChapter = {
    title: `Chapter ${1}`,
    lessons: [],
    quizzes: [],
    assignments: []
  };
  let chapterCounter = 1;

  const currentChapterItems = document.getElementById('currentChapterItems');
  const lessonList = document.getElementById('lessonList');
  const quizList = document.getElementById('quizList');
  const assignmentList = document.getElementById('assignmentList');
  const savedChaptersList = document.getElementById('savedChaptersList');
  const btnSaveChapter = document.getElementById('btnSaveChapter');
  const btnNewChapter = document.getElementById('btnNewChapter');
  const finalExamSection = document.getElementById('finalExamSection');

  // Initialize
  loadSavedChapters();

  // Save Chapter
  btnSaveChapter.addEventListener('click', async () => {
    if (currentChapter.lessons.length === 0 && currentChapter.quizzes.length === 0 && currentChapter.assignments.length === 0) {
      alert('Please add at least one lesson, quiz, or assignment before saving the chapter.');
      return;
    }

    const chapterTitle = prompt('Enter chapter title:', currentChapter.title) || currentChapter.title;
    
    try {
      // Save chapter to server
      const formData = new FormData();
      formData.append('title', chapterTitle);
      formData.append('lessons', JSON.stringify(currentChapter.lessons));
      formData.append('quizzes', JSON.stringify(currentChapter.quizzes));
      formData.append('assignments', JSON.stringify(currentChapter.assignments));

      const res = await fetch(`{{ url_for('api_create_chapter', unit_id=0) }}`.replace('0', unitId), {
        method: 'POST',
        body: formData
      });
      
      const json = await res.json();
      
      if (json.ok) {
        // Reset current chapter
        resetCurrentChapter();
        // Reload saved chapters
        await loadSavedChapters();
        alert('Chapter saved successfully!');
        
        // Check if we should show final exam section (after 10 chapters)
        checkFinalExamEligibility();
      } else {
        alert(json.error || 'Failed to save chapter');
      }
    } catch (error) {
      alert('Error saving chapter: ' + error.message);
    }
  });

  // New Chapter
  btnNewChapter.addEventListener('click', () => {
    if (currentChapter.lessons.length > 0 || currentChapter.quizzes.length > 0 || currentChapter.assignments.length > 0) {
      if (!confirm('You have unsaved items. Start a new chapter anyway?')) {
        return;
      }
    }
    resetCurrentChapter();
  });

  // Function to add item from external pages (call this from your other HTML pages)
  window.addChapterItem = function(item) {
    if (item.type === 'lesson') {
      currentChapter.lessons.push(item);
      addLessonToDisplay(item);
    } else if (item.type === 'quiz') {
      currentChapter.quizzes.push(item);
      addQuizToDisplay(item);
    } else if (item.type === 'assignment') {
      currentChapter.assignments.push(item);
      addAssignmentToDisplay(item);
    }
    updateSaveButton();
  };

  function addLessonToDisplay(lesson) {
    currentChapterItems.style.display = 'block';
    const lessonEl = document.createElement('div');
    lessonEl.className = 'current-item';
    lessonEl.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span class="item-badge">Lesson</span>
          <strong>${escapeHtml(lesson.title)}</strong>
          ${lesson.duration ? `<small class="text-muted ms-2">${escapeHtml(lesson.duration)}</small>` : ''}
        </div>
        <button class="btn btn-sm btn-outline-danger" onclick="removeItem('lesson', ${lesson.id})">×</button>
      </div>
      ${lesson.description ? `<div class="mt-1 small text-muted">${escapeHtml(lesson.description)}</div>` : ''}
    `;
    lessonList.appendChild(lessonEl);
  }

  function addQuizToDisplay(quiz) {
    currentChapterItems.style.display = 'block';
    const quizEl = document.createElement('div');
    quizEl.className = 'current-item';
    quizEl.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span class="item-badge">Quiz</span>
          <strong>${escapeHtml(quiz.title)}</strong>
          ${quiz.duration ? `<small class="text-muted ms-2">${escapeHtml(quiz.duration)}</small>` : ''}
        </div>
        <button class="btn btn-sm btn-outline-danger" onclick="removeItem('quiz', ${quiz.id})">×</button>
      </div>
      ${quiz.description ? `<div class="mt-1 small text-muted">${escapeHtml(quiz.description)}</div>` : ''}
    `;
    quizList.appendChild(quizEl);
  }

  function addAssignmentToDisplay(assignment) {
    currentChapterItems.style.display = 'block';
    const assignmentEl = document.createElement('div');
    assignmentEl.className = 'current-item';
    assignmentEl.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span class="item-badge">Assignment</span>
          <strong>${escapeHtml(assignment.title)}</strong>
          ${assignment.duration ? `<small class="text-muted ms-2">${escapeHtml(assignment.duration)}</small>` : ''}
        </div>
        <button class="btn btn-sm btn-outline-danger" onclick="removeItem('assignment', ${assignment.id})">×</button>
      </div>
      ${assignment.instructions ? `<div class="mt-1 small text-muted">${escapeHtml(assignment.instructions)}</div>` : ''}
    `;
    assignmentList.appendChild(assignmentEl);
  }

  function removeItem(type, id) {
    if (type === 'lesson') {
      currentChapter.lessons = currentChapter.lessons.filter(l => l.id !== id);
      lessonList.innerHTML = '<h6 class="text-muted">Lessons</h6>';
      currentChapter.lessons.forEach(addLessonToDisplay);
    } else if (type === 'quiz') {
      currentChapter.quizzes = currentChapter.quizzes.filter(q => q.id !== id);
      quizList.innerHTML = '<h6 class="text-muted">Quizzes</h6>';
      currentChapter.quizzes.forEach(addQuizToDisplay);
    } else if (type === 'assignment') {
      currentChapter.assignments = currentChapter.assignments.filter(a => a.id !== id);
      assignmentList.innerHTML = '<h6 class="text-muted">Assignments</h6>';
      currentChapter.assignments.forEach(addAssignmentToDisplay);
    }
    
    updateSaveButton();
  }

  function updateSaveButton() {
    const hasItems = currentChapter.lessons.length > 0 || currentChapter.quizzes.length > 0 || currentChapter.assignments.length > 0;
    btnSaveChapter.disabled = !hasItems;
  }

  function resetCurrentChapter() {
    chapterCounter++;
    currentChapter = {
      title: `Chapter ${chapterCounter}`,
      lessons: [],
      quizzes: [],
      assignments: []
    };
    
    lessonList.innerHTML = '<h6 class="text-muted">Lessons</h6>';
    quizList.innerHTML = '<h6 class="text-muted">Quizzes</h6>';
    assignmentList.innerHTML = '<h6 class="text-muted">Assignments</h6>';
    currentChapterItems.style.display = 'none';
    btnSaveChapter.disabled = true;
  }

  async function loadSavedChapters() {
    try {
      const res = await fetch(`{{ url_for('api_get_curriculum', unit_id=0) }}`.replace('0', unitId));
      const json = await res.json();
      
      if (json.ok) {
        const chapters = json.chapters || [];
        savedChaptersList.innerHTML = '';
        
        chapters.forEach(chapter => {
          const chapterEl = document.createElement('div');
          chapterEl.className = 'card chapter-card mb-3';
          chapterEl.innerHTML = `
            <div class="card-body">
              <h5 class="card-title">+ ${escapeHtml(chapter.title)}</h5>
              <div class="mt-2">
                ${(chapter.items || []).map(item => `
                  <div class="current-item mb-2">
                    <span class="item-badge">${item.type}</span>
                    <strong>${escapeHtml(item.title)}</strong>
                    ${item.duration ? `<small class="text-muted ms-2">${escapeHtml(item.duration)}</small>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
          savedChaptersList.appendChild(chapterEl);
        });

        // Check final exam eligibility after loading chapters
        checkFinalExamEligibility(chapters.length);
      }
    } catch (error) {
      console.error('Error loading saved chapters:', error);
    }
  }

  function checkFinalExamEligibility(chapterCount = null) {
    // Count saved chapters or use provided count
    const savedChapters = document.querySelectorAll('#savedChaptersList .chapter-card');
    const totalChapters = chapterCount !== null ? chapterCount : savedChapters.length;
    
    // Show final exam section after 10 chapters
    if (totalChapters >= 10) {
      finalExamSection.style.display = 'block';
    } else {
      finalExamSection.style.display = 'none';
    }
  }

  function escapeHtml(s) {
    return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Make removeItem function available globally
  window.removeItem = removeItem;
});
</script>
{% endblock %}
