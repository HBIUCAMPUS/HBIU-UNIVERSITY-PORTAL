{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-md-12">
      <h1 class="h3 mb-0">HBI Virtual Campus</h1>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row">
    <div class="col-md-12">
      <h2 class="h4 mb-4">Curriculum</h2>

      <!-- Course Title Section -->
      <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
          <h3 class="card-title text-uppercase fw-bold mb-2" style="color: #2c3e50; font-size: 1.1rem;">
            {{ unit.title if unit else "INTRODUCTION TO PROGRAMMING" }}
          </h3>
          <p class="card-text text-muted mb-0 small">
            {{ unit.description or "Course description will appear here" }}
          </p>
        </div>
      </div>

      <!-- Current Chapter Items (Temporary) -->
      <div id="currentChapterItems" class="mb-4" style="display: none;">
        <div class="card mb-4">
          <div class="card-header bg-light">
            <h5 class="mb-0">Current Chapter Items</h5>
          </div>
          <div class="card-body">
            <div id="lessonList" class="mb-3">
              <h6 class="text-muted">Lessons</h6>
              <!-- Lessons will be added here -->
            </div>
            <div id="quizList" class="mb-3">
              <h6 class="text-muted">Quizzes</h6>
              <!-- Quizzes will be added here -->
            </div>
            <div id="assignmentList" class="mb-3">
              <h6 class="text-muted">Assignments</h6>
              <!-- Assignments will be added here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Add Content Boxes -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card text-center h-100">
            <div class="card-body">
              <h5 class="card-title">Lesson</h5>
              <p class="card-text text-muted small">Add learning materials and content</p>
              <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#lessonModal">
                + Add Lesson
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center h-100">
            <div class="card-body">
              <h5 class="card-title">Quiz</h5>
              <p class="card-text text-muted small">Create assessment questions</p>
              <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#quizModal">
                + Add Quiz
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center h-100">
            <div class="card-body">
              <h5 class="card-title">Assignment</h5>
              <p class="card-text text-muted small">Create tasks for students</p>
              <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#assignmentModal">
                + Add Assignment
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Save Chapter Button -->
      <div class="text-center mb-4">
        <button id="btnSaveChapter" class="btn btn-primary" disabled>
          Save Chapter
        </button>
      </div>

      <!-- Saved Chapters List -->
      <div id="savedChaptersList" class="mb-4">
        <!-- Saved chapters will appear here -->
      </div>

      <!-- Add New Chapter Button -->
      <div class="text-center">
        <button id="btnNewChapter" class="btn btn-outline-primary">
          + Add New Chapter
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Lesson Modal -->
<div class="modal fade" id="lessonModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form class="modal-content" id="lessonForm">
      <div class="modal-header">
        <h5 class="modal-title">Add Lesson</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input name="title" class="form-control" required placeholder="Enter lesson title">
        </div>
        <div class="mb-3">
          <label class="form-label">Description / Notes</label>
          <textarea name="description" class="form-control" rows="4" placeholder="Add lesson description or notes"></textarea>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">YouTube URL (optional)</label>
            <input name="video_url" class="form-control" placeholder="https://youtube.com/...">
          </div>
          <div class="col-md-6">
            <label class="form-label">Upload Video (optional)</label>
            <input type="file" name="video_file" class="form-control" accept="video/*">
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label">Upload Lesson Notes (PDF/Doc, optional)</label>
          <input type="file" name="notes_file" class="form-control" accept=".pdf,.doc,.docx,.ppt,.pptx">
        </div>
        <div class="mt-3">
          <label class="form-label">Estimated Duration (e.g., 15m)</label>
          <input name="duration" class="form-control" placeholder="15m">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
        <button class="btn btn-primary" type="submit">Add Lesson</button>
      </div>
    </form>
  </div>
</div>

<!-- Quiz Modal -->
<div class="modal fade" id="quizModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="quizForm">
      <div class="modal-header">
        <h5 class="modal-title">Add Quiz</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input name="title" class="form-control" required placeholder="Enter quiz title">
        </div>
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control" rows="3" placeholder="Add quiz description"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Duration (e.g., 10m)</label>
          <input name="duration" class="form-control" placeholder="10m">
        </div>
        <div class="mb-3">
          <label class="form-label">Upload Quiz File (optional)</label>
          <input type="file" name="attachment" class="form-control" accept=".pdf,.doc,.docx">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
        <button class="btn btn-primary" type="submit">Add Quiz</button>
      </div>
    </form>
  </div>
</div>

<!-- Assignment Modal -->
<div class="modal fade" id="assignmentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="assignmentForm">
      <div class="modal-header">
        <h5 class="modal-title">Add Assignment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input name="title" class="form-control" required placeholder="Enter assignment title">
        </div>
        <div class="mb-3">
          <label class="form-label">Instructions</label>
          <textarea name="instructions" class="form-control" rows="4" placeholder="Add assignment instructions"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Due/Duration (optional)</label>
          <input name="duration" class="form-control" placeholder="e.g., Due week 3">
        </div>
        <div class="mb-3">
          <label class="form-label">Upload Attachment (optional)</label>
          <input type="file" name="attachment" class="form-control" accept=".pdf,.doc,.docx,.zip">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
        <button class="btn btn-primary" type="submit">Add Assignment</button>
      </div>
    </form>
  </div>
</div>

<style>
.card {
  border: none;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.chapter-card {
  border-left: 4px solid #4e73df;
}

.item-badge {
  background: #e3f2fd;
  color: #1976d2;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 500;
}

.current-item {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 0.75rem;
  margin-bottom: 0.5rem;
}

.btn-primary {
  background-color: #4e73df;
  border-color: #4e73df;
}

.btn-primary:hover {
  background-color: #2e59d9;
  border-color: #2e59d9;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const unitId = {{ unit.id if unit else 0 }};
  let currentChapter = {
    title: `Chapter ${1}`,
    lessons: [],
    quizzes: [],
    assignments: []
  };
  let chapterCounter = 1;

  const currentChapterItems = document.getElementById('currentChapterItems');
  const lessonList = document.getElementById('lessonList');
  const quizList = document.getElementById('quizList');
  const assignmentList = document.getElementById('assignmentList');
  const savedChaptersList = document.getElementById('savedChaptersList');
  const btnSaveChapter = document.getElementById('btnSaveChapter');
  const btnNewChapter = document.getElementById('btnNewChapter');

  // Initialize
  loadSavedChapters();

  // Lesson Form
  document.getElementById('lessonForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const lesson = {
      id: Date.now(),
      title: formData.get('title'),
      description: formData.get('description'),
      video_url: formData.get('video_url'),
      duration: formData.get('duration'),
      type: 'lesson'
    };
    
    currentChapter.lessons.push(lesson);
    addLessonToDisplay(lesson);
    e.target.reset();
    bootstrap.Modal.getInstance(document.getElementById('lessonModal')).hide();
    updateSaveButton();
  });

  // Quiz Form
  document.getElementById('quizForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const quiz = {
      id: Date.now(),
      title: formData.get('title'),
      description: formData.get('description'),
      duration: formData.get('duration'),
      type: 'quiz'
    };
    
    currentChapter.quizzes.push(quiz);
    addQuizToDisplay(quiz);
    e.target.reset();
    bootstrap.Modal.getInstance(document.getElementById('quizModal')).hide();
    updateSaveButton();
  });

  // Assignment Form
  document.getElementById('assignmentForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const assignment = {
      id: Date.now(),
      title: formData.get('title'),
      instructions: formData.get('instructions'),
      duration: formData.get('duration'),
      type: 'assignment'
    };
    
    currentChapter.assignments.push(assignment);
    addAssignmentToDisplay(assignment);
    e.target.reset();
    bootstrap.Modal.getInstance(document.getElementById('assignmentModal')).hide();
    updateSaveButton();
  });

  // Save Chapter
  btnSaveChapter.addEventListener('click', async () => {
    if (currentChapter.lessons.length === 0 && currentChapter.quizzes.length === 0 && currentChapter.assignments.length === 0) {
      alert('Please add at least one lesson, quiz, or assignment before saving the chapter.');
      return;
    }

    const chapterTitle = prompt('Enter chapter title:', currentChapter.title) || currentChapter.title;
    
    try {
      // Save chapter to server
      const formData = new FormData();
      formData.append('title', chapterTitle);
      formData.append('lessons', JSON.stringify(currentChapter.lessons));
      formData.append('quizzes', JSON.stringify(currentChapter.quizzes));
      formData.append('assignments', JSON.stringify(currentChapter.assignments));

      const res = await fetch(`{{ url_for('api_create_chapter', unit_id=0) }}`.replace('0', unitId), {
        method: 'POST',
        body: formData
      });
      
      const json = await res.json();
      
      if (json.ok) {
        // Reset current chapter
        resetCurrentChapter();
        // Reload saved chapters
        await loadSavedChapters();
        alert('Chapter saved successfully!');
      } else {
        alert(json.error || 'Failed to save chapter');
      }
    } catch (error) {
      alert('Error saving chapter: ' + error.message);
    }
  });

  // New Chapter
  btnNewChapter.addEventListener('click', () => {
    if (currentChapter.lessons.length > 0 || currentChapter.quizzes.length > 0 || currentChapter.assignments.length > 0) {
      if (!confirm('You have unsaved items. Start a new chapter anyway?')) {
        return;
      }
    }
    resetCurrentChapter();
  });

  function addLessonToDisplay(lesson) {
    currentChapterItems.style.display = 'block';
    const lessonEl = document.createElement('div');
    lessonEl.className = 'current-item';
    lessonEl.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span class="item-badge">Lesson</span>
          <strong>${escapeHtml(lesson.title)}</strong>
          ${lesson.duration ? `<small class="text-muted ms-2">${escapeHtml(lesson.duration)}</small>` : ''}
        </div>
        <button class="btn btn-sm btn-outline-danger" onclick="removeItem('lesson', ${lesson.id})">×</button>
      </div>
      ${lesson.description ? `<div class="mt-1 small text-muted">${escapeHtml(lesson.description)}</div>` : ''}
    `;
    lessonList.appendChild(lessonEl);
  }

  function addQuizToDisplay(quiz) {
    currentChapterItems.style.display = 'block';
    const quizEl = document.createElement('div');
    quizEl.className = 'current-item';
    quizEl.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span class="item-badge">Quiz</span>
          <strong>${escapeHtml(quiz.title)}</strong>
          ${quiz.duration ? `<small class="text-muted ms-2">${escapeHtml(quiz.duration)}</small>` : ''}
        </div>
        <button class="btn btn-sm btn-outline-danger" onclick="removeItem('quiz', ${quiz.id})">×</button>
      </div>
      ${quiz.description ? `<div class="mt-1 small text-muted">${escapeHtml(quiz.description)}</div>` : ''}
    `;
    quizList.appendChild(quizEl);
  }

  function addAssignmentToDisplay(assignment) {
    currentChapterItems.style.display = 'block';
    const assignmentEl = document.createElement('div');
    assignmentEl.className = 'current-item';
    assignmentEl.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span class="item-badge">Assignment</span>
          <strong>${escapeHtml(assignment.title)}</strong>
          ${assignment.duration ? `<small class="text-muted ms-2">${escapeHtml(assignment.duration)}</small>` : ''}
        </div>
        <button class="btn btn-sm btn-outline-danger" onclick="removeItem('assignment', ${assignment.id})">×</button>
      </div>
      ${assignment.instructions ? `<div class="mt-1 small text-muted">${escapeHtml(assignment.instructions)}</div>` : ''}
    `;
    assignmentList.appendChild(assignmentEl);
  }

  function removeItem(type, id) {
    if (type === 'lesson') {
      currentChapter.lessons = currentChapter.lessons.filter(l => l.id !== id);
      lessonList.innerHTML = '<h6 class="text-muted">Lessons</h6>';
      currentChapter.lessons.forEach(addLessonToDisplay);
    } else if (type === 'quiz') {
      currentChapter.quizzes = currentChapter.quizzes.filter(q => q.id !== id);
      quizList.innerHTML = '<h6 class="text-muted">Quizzes</h6>';
      currentChapter.quizzes.forEach(addQuizToDisplay);
    } else if (type === 'assignment') {
      currentChapter.assignments = currentChapter.assignments.filter(a => a.id !== id);
      assignmentList.innerHTML = '<h6 class="text-muted">Assignments</h6>';
      currentChapter.assignments.forEach(addAssignmentToDisplay);
    }
    
    updateSaveButton();
  }

  function updateSaveButton() {
    const hasItems = currentChapter.lessons.length > 0 || currentChapter.quizzes.length > 0 || currentChapter.assignments.length > 0;
    btnSaveChapter.disabled = !hasItems;
  }

  function resetCurrentChapter() {
    chapterCounter++;
    currentChapter = {
      title: `Chapter ${chapterCounter}`,
      lessons: [],
      quizzes: [],
      assignments: []
    };
    
    lessonList.innerHTML = '<h6 class="text-muted">Lessons</h6>';
    quizList.innerHTML = '<h6 class="text-muted">Quizzes</h6>';
    assignmentList.innerHTML = '<h6 class="text-muted">Assignments</h6>';
    currentChapterItems.style.display = 'none';
    btnSaveChapter.disabled = true;
  }

  async function loadSavedChapters() {
    try {
      const res = await fetch(`{{ url_for('api_get_curriculum', unit_id=0) }}`.replace('0', unitId));
      const json = await res.json();
      
      if (json.ok) {
        const chapters = json.chapters || [];
        savedChaptersList.innerHTML = '';
        
        chapters.forEach(chapter => {
          const chapterEl = document.createElement('div');
          chapterEl.className = 'card chapter-card mb-3';
          chapterEl.innerHTML = `
            <div class="card-body">
              <h5 class="card-title">+ ${escapeHtml(chapter.title)}</h5>
              <div class="mt-2">
                ${(chapter.items || []).map(item => `
                  <div class="current-item mb-2">
                    <span class="item-badge">${item.type}</span>
                    <strong>${escapeHtml(item.title)}</strong>
                    ${item.duration ? `<small class="text-muted ms-2">${escapeHtml(item.duration)}</small>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
          savedChaptersList.appendChild(chapterEl);
        });
      }
    } catch (error) {
      console.error('Error loading saved chapters:', error);
    }
  }

  function escapeHtml(s) {
    return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Make removeItem function available globally
  window.removeItem = removeItem;
});
</script>
{% endblock %}
